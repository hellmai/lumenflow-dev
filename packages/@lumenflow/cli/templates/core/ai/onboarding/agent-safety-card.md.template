# Agent Safety Card

**Last updated:** {{DATE}}

Quick reference for AI agents working in LumenFlow projects.

---

## Stop and Ask When

- Same error repeats 3 times
- Auth or permissions changes needed
- PII/secrets involved
- Cloud spend decisions
- Policy changes required
- Anything feels irreversible

---

## Never Do

| Action                   | Why              |
| ------------------------ | ---------------- |
| `git reset --hard`       | Data loss        |
| `git push --force`       | History rewrite  |
| `--no-verify`            | Bypasses safety  |
| `git stash` (on main)    | Hides work       |
| `git clean -fd`          | Deletes files    |
| Work in main after claim | Breaks isolation |
| Skip wu:done             | Incomplete WU    |

---

## Always Do

| Action                     | Why              |
| -------------------------- | ---------------- |
| Read WU spec first         | Understand scope |
| cd to worktree after claim | Isolation        |
| Write tests before code    | TDD              |
| Run gates before wu:done   | Quality          |
| Run wu:done                | Complete WU      |
| Stay within code_paths     | Scope discipline |

---

## Universal Safety Mechanisms

### Git Safety Wrapper

Use `scripts/safe-git` instead of system `git` when possible.

It blocks:

- `git worktree remove`
- `git reset --hard`
- `git clean -fd`
- `git push --force`

### Repo Hooks (Husky)

These run for everyone:

- Secret scanning on staged content
- Absolute path scanning on staged content
- Lockfile sync checks
- Worktree discipline checks

Audit logs:

- `.lumenflow/safety-blocks.log` (blocked safety actions)
- `.lumenflow/force-bypasses.log` (LUMENFLOW_FORCE bypasses)

---

## Error Handling

### Max 3 Attempts

If same error happens 3 times:

1. Stop trying
2. Document what happened
3. Ask for help

### Gate Failures

1. Read the error message
2. Fix the underlying issue
3. Re-run gates
4. Never use `--skip-gates` for new failures

---

## Quick Commands

```bash
# Check lane availability
cat docs/04-operations/tasks/status.md

# Claim a WU
pnpm wu:claim --id WU-XXX --lane <Lane>

# Work in worktree
cd worktrees/<lane>-wu-xxx

# Run gates
pnpm gates          # Code changes
pnpm gates --docs-only  # Docs changes

# Complete WU
cd /path/to/main
pnpm wu:done --id WU-XXX
```

---

## Completion Checklist

- [ ] Gates pass
- [ ] cd to main
- [ ] Run wu:done
- [ ] Verify success output
- [ ] Report completion

---

## When Uncertain

Choose the safer path:

- Don't modify files outside code_paths
- Don't bypass hooks
- Don't skip gates
- Ask rather than assume

---

## Emergency Override (LUMENFLOW_FORCE)

In rare cases, you may need to bypass safety mechanisms. This requires explicit user approval and creates an audit trail.

### When Emergency Override is Appropriate

- Fixing YAML parsing bugs in WU specs (spec infrastructure issue)
- Emergency production hotfixes (with user present)
- Recovering from corrupted workflow state
- Bootstrap operations when CLI not yet built

### When NOT to Use Emergency Override

- Skipping failing tests
- Avoiding code review
- Working around gate failures
- Convenience or speed

### How to Use LUMENFLOW_FORCE

**Step 1: Get user approval**

Agents MUST stop and ask before using LUMENFLOW_FORCE. Present the situation to the user:

```
I need to bypass the safety check for [reason].
This will be logged to .lumenflow/force-bypasses.log.
Do you approve? (yes/no)
```

**Step 2: Execute with audit trail**

```bash
# With reason (preferred)
LUMENFLOW_FORCE_REASON="user-approved: <reason>" LUMENFLOW_FORCE=1 git <command>

# Example: bypass safe-git for reset --hard
LUMENFLOW_FORCE_REASON="user-approved: recovering corrupted state" LUMENFLOW_FORCE=1 git reset --hard HEAD

# Example: bypass hook for commit
LUMENFLOW_FORCE_REASON="user-approved: false positive secret detection" LUMENFLOW_FORCE=1 git commit -m "fix: update config"
```

**Step 3: Document in WU notes**

Add a note to the WU YAML explaining the bypass:

```yaml
notes: |
  Used LUMENFLOW_FORCE to bypass [mechanism] because [reason].
  Approved by user at [timestamp].
```

### Audit Log Format

All bypasses are logged to `.lumenflow/force-bypasses.log`:

```
ISO_TIMESTAMP|BYPASSED|COMMAND_OR_HOOK|USER|BRANCH|REASON|CWD
```

Example:

```
{{DATE}}T12:34:56Z|BYPASSED|git reset --hard HEAD|tom|lane/core/wu-1172|user-approved: recovering state|<cwd>
```

### Warning When No Reason Provided

If LUMENFLOW_FORCE=1 is used without LUMENFLOW_FORCE_REASON, a warning is printed:

```
=== LUMENFLOW FORCE WARNING ===
LUMENFLOW_FORCE used without LUMENFLOW_FORCE_REASON.
Please provide a reason for audit trail:
  LUMENFLOW_FORCE_REASON="your reason" LUMENFLOW_FORCE=1 git ...
===============================
```

The command still proceeds, but "NO_REASON" is logged.

---

## Task Tool Hook Limitation (WU-1282)

**Critical**: Claude Code's Task tool spawns sub-agents in a new session that does NOT inherit PreToolUse hooks from `.claude/settings.json`.

### What This Means

When you spawn a sub-agent via Task tool:

- The sub-agent runs in a fresh context
- PreToolUse hooks (like `validate-worktree-path.sh`) do NOT run
- Sub-agents can write to main checkout even when worktrees exist

### Workaround for Sub-Agents

Sub-agents MUST manually verify worktree discipline before any Write/Edit:

```bash
# BEFORE any file operation, verify location
pwd
# Must show: /path/to/repo/worktrees/<lane>-wu-xxx

# If not in worktree, navigate first
cd worktrees/<lane>-wu-xxx
```

### For Orchestrators

When generating sub-agent handoff via `pnpm wu:brief` (or `pnpm wu:delegate` for lineage):

1. The handoff prompt includes constraint #9 (WORKTREE DISCIPLINE)
2. Sub-agents are instructed to manually verify worktree location
3. This constraint compensates for the missing hook enforcement

### Root Cause

This is a Claude Code platform limitation, not a LumenFlow bug. Hooks defined in `.claude/settings.json` only apply to the parent session that loaded the settings file. Task-spawned sub-agents start fresh sessions without hook inheritance.

---

## Setup and Verification

### Claude Code

Claude Code automatically respects LumenFlow safety through:

1. **CLAUDE.md** - Entry point that references safety rules
2. **.claude/skills/** - Skills include safety context
3. **.claude/agents/** - Agent definitions include constraints

No additional setup required. Claude Code will read these files on startup.

### Cursor

Cursor uses `.cursor/rules/lumenflow.md` for safety rules.

**Setup:**

```bash
# Initialize LumenFlow with Cursor overlay
lumenflow init --client cursor

# Or add to existing project
mkdir -p .cursor/rules
# Copy lumenflow.md template to .cursor/rules/
```

**Verification:**

1. Open a file in Cursor
2. Start a chat with Cursor AI
3. Ask: "What are the LumenFlow safety rules?"
4. Verify it mentions: worktree discipline, forbidden git commands, LUMENFLOW_FORCE

### Windsurf

Windsurf uses `.windsurf/rules/lumenflow.md` for safety rules.

**Setup:**

```bash
# Initialize LumenFlow with Windsurf overlay
lumenflow init --client windsurf

# Or add to existing project
mkdir -p .windsurf/rules
# Copy lumenflow.md template to .windsurf/rules/
```

**Verification:**

1. Open project in Windsurf
2. Start a Cascade session
3. Ask: "What safety mechanisms does this project use?"
4. Verify it mentions: safe-git wrapper, Husky hooks, audit logs

### Manual Verification

Test that safety mechanisms work:

```bash
# Verify safe-git blocks dangerous commands
./scripts/safe-git reset --hard HEAD
# Should show: === LUMENFLOW SAFETY BLOCK ===

# Verify hooks are installed
ls -la .husky/
# Should show: pre-commit, commit-msg, etc.

# Verify bypass works with audit
LUMENFLOW_FORCE_REASON="testing" LUMENFLOW_FORCE=1 ./scripts/safe-git --version
# Should succeed and log to .lumenflow/force-bypasses.log
```
