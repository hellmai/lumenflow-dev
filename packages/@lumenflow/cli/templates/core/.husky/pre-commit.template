#!/bin/sh
#
# LumenFlow Pre-Commit Hook (Vendor-Agnostic)
#
# This hook enforces worktree discipline for all users and AI agents.
# It blocks direct commits to main/master branches.
#
# Rules:
#   1. BLOCK commits to main/master (use WU workflow instead)
#   2. ALLOW commits on lane branches (lane/*/wu-*)
#   3. ALLOW commits on tmp/* branches (CLI micro-worktrees)
#
# Escape hatch (logged, emergency only):
#   LUMENFLOW_FORCE=1 LUMENFLOW_FORCE_REASON="reason" git commit ...
#
# Configuration:
#   Package manager is configured in .lumenflow.config.yaml (package_manager)
#   Default: pnpm (examples below use pnpm - adjust for your project)
#
# For documentation on the WU workflow, see:
#   - LUMENFLOW.md
#   - docs/_frameworks/lumenflow/agent/onboarding/starting-prompt.md
#

# Skip on tmp/* branches (CLI micro-worktrees in /tmp with no node_modules)
BRANCH=$(git rev-parse --abbrev-ref HEAD 2>/dev/null)
case "$BRANCH" in tmp/*) exit 0 ;; esac

# Check for force bypass (logged for audit)
if [ "$LUMENFLOW_FORCE" = "1" ]; then
  if [ -z "$LUMENFLOW_FORCE_REASON" ]; then
    echo "" >&2
    echo "[pre-commit] Warning: Hook bypass used without a reason." >&2
    echo "Please provide a reason for the audit trail." >&2
    echo "" >&2
  fi
  # Log bypass to .lumenflow/ for audit trail
  LUMENFLOW_DIR="$(git rev-parse --show-toplevel 2>/dev/null)/.lumenflow"
  if [ -n "$LUMENFLOW_DIR" ]; then
    mkdir -p "$LUMENFLOW_DIR"
    TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
    USER=$(git config user.name 2>/dev/null || echo "unknown")
    echo "${TIMESTAMP} | pre-commit | ${USER} | ${BRANCH} | ${LUMENFLOW_FORCE_REASON:-no reason} | $(pwd)" >> "${LUMENFLOW_DIR}/force-bypasses.log"
  fi
  exit 0
fi

# Block direct commits to main/master
case "$BRANCH" in
  main|master)
    echo "" >&2
    echo "==================================================================" >&2
    echo "  DIRECT COMMIT TO ${BRANCH} BLOCKED" >&2
    echo "==================================================================" >&2
    echo "" >&2
    echo "WHY THIS HAPPENS" >&2
    echo "------------------------------------------------------------------" >&2
    echo "LumenFlow protects main from direct commits to ensure:" >&2
    echo "  - All work is tracked in Work Units (WUs)" >&2
    echo "  - Changes can be reviewed and coordinated" >&2
    echo "  - Parallel work across lanes stays isolated" >&2
    echo "" >&2
    echo "WHAT TO DO" >&2
    echo "------------------------------------------------------------------" >&2
    echo "" >&2
    echo "1. If you have a Work Unit to implement:" >&2
    echo "     pnpm wu:claim --id WU-XXXX --lane \"<Lane>\"" >&2
    echo "     cd worktrees/<lane>-wu-xxxx" >&2
    echo "   Then make your commits in the worktree" >&2
    echo "" >&2
    echo "2. If you need to create a new Work Unit:" >&2
    echo "     pnpm wu:create --lane \"<Lane>\" --title \"Your task\"" >&2
    echo "   This generates a WU ID, then claim it as above" >&2
    echo "" >&2
    echo "NEED HELP?" >&2
    echo "------------------------------------------------------------------" >&2
    echo "  - Read: LUMENFLOW.md (workflow overview)" >&2
    echo "  - Read: docs/_frameworks/lumenflow/agent/onboarding/" >&2
    echo "  - Run:  pnpm wu:help" >&2
    echo "" >&2
    echo "------------------------------------------------------------------" >&2
    echo "STUCK?" >&2
    echo "------------------------------------------------------------------" >&2
    echo "If you need to fix workflow state:" >&2
    echo "  pnpm wu:recover --id WU-XXXX" >&2
    echo "------------------------------------------------------------------" >&2
    echo "" >&2
    exit 1
    ;;
esac

# Allow commits on lane branches and other branches
exit 0
