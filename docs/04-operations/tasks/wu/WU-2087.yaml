id: WU-2087
title: "lumenflow:upgrade self-bootstrap: run target version's script to avoid chicken-and-egg bugs"
lane: 'Framework: CLI WU Commands'
type: bug
status: done
priority: P1
created: 2026-02-23
code_paths:
  - packages/@lumenflow/cli/src/lumenflow-upgrade.ts
tests:
  manual:
    - pnpm lumenflow:upgrade --latest on a single-package consumer repo
  unit:
    - packages/@lumenflow/cli/src/__tests__/lumenflow-upgrade.test.ts
  e2e: []
artifacts:
  - .lumenflow/stamps/WU-2087.done
dependencies: []
risks: []
notes: (auto) Add implementation notes, rollout context, or a short summary of the plan/conversation.
requires_review: false
assigned_to: tom@hellm.ai
exposure: backend-only
escalation_triggers: []
requires_human_escalation: false
requires_cso_approval: false
requires_cto_approval: false
requires_design_approval: false
description: "The lumenflow:upgrade command runs from the INSTALLED (old) version of @lumenflow/cli.
  If that version has bugs (e.g., WU-1527 unconditional -w flag), the upgrade fails inside the
  micro-worktree and agents fall back to manual pnpm add, dirtying main. This is a chicken-and-egg
  problem: you need the fixed upgrade script to upgrade to the fixed version. The fix:
  self-bootstrap â€” download/npx the TARGET version's upgrade script before running the actual
  upgrade. This also ensures the command works for ALL repo types (single-package, monorepo, JS, TS)
  since the latest script always has the latest compatibility fixes."
acceptance:
  - 'lumenflow:upgrade self-bootstraps: fetches target version CLI and delegates to its upgrade
    script'
  - Works in single-package repos (no pnpm-workspace.yaml)
  - Works in pnpm monorepos (with pnpm-workspace.yaml)
  - Micro-worktree isolation preserved (main never dirtied)
claimed_mode: worktree
worktree_path: /home/tom/source/hellmai/os/worktrees/framework-cli-wu-commands-wu-2087
claimed_at: 2026-02-23T16:59:48.015Z
baseline_main_sha: 2a0c371ca5eabba899be19f7963b8804421bdc5d
session_id: bacc95b3-fa2f-4626-8b20-08f95e0322dd
approved_by:
  - tom@hellm.ai
approved_at: 2026-02-23T16:59:48.024Z
locked: true
completed_at: 2026-02-23T17:12:14.531Z
completed: 2026-02-23
