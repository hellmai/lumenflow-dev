id: WU-2110
title: Add ratcheting AST guard for UnsafeAny type alias usage
lane: 'Framework: Core Lifecycle'
type: refactor
status: done
priority: P0
created: 2026-02-24
code_paths:
  - packages/@lumenflow/core/src/__tests__/type-safety-guard.test.ts
  - tools/baselines/enforcement/
tests:
  manual:
    - Run pnpm test --testNamePattern=type-safety-guard and verify guard passes
    - Add a deliberate UnsafeAny usage and verify guard fails
  unit:
    - packages/@lumenflow/core/src/__tests__/type-safety-guard.test.ts
  e2e: []
artifacts:
  - .lumenflow/stamps/WU-2110.done
dependencies: []
initiative: INIT-037
phase: 1
spec_refs:
  - /home/tom/.claude/plans/wild-foraging-taco.md
risks: []
notes: (auto) Add implementation notes, rollout context, or a short summary of the plan/conversation.
requires_review: false
claimed_mode: worktree
assigned_to: tom@hellm.ai
claimed_at: 2026-02-24T20:08:08.883Z
worktree_path: /home/tom/source/hellmai/os/worktrees/framework-core-lifecycle-wu-2110
session_id: f2df760b-3c6d-4c20-974d-da2437d84b28
exposure: backend-only
escalation_triggers: []
requires_human_escalation: false
approved_by:
  - tom@hellm.ai
approved_at: 2026-02-24T20:08:08.889Z
requires_cso_approval: false
requires_cto_approval: false
requires_design_approval: false
description: 'type UnsafeAny = ReturnType<typeof JSON.parse> resolves to any, completely bypassing
  @typescript-eslint/no-explicit-any. Current scan: 580 uses across 194 files (510 across 156
  production files). Unlike as any (visible in review), UnsafeAny looks type-safe but silently
  propagates any through the codebase. New AST guard using ts.isTypeReferenceNode() with dynamic
  baseline (computed at test-time, persisted in tools/baselines/enforcement/, fails if count
  increases). Defined in both cli/src/types.d.ts and core/src/types.d.ts.'
acceptance:
  - 'New file: packages/@lumenflow/core/src/__tests__/type-safety-guard.test.ts using TypeScript AST
    to detect UnsafeAny type references'
  - Guard uses dynamic baseline (computeBaselineFromSnapshot) persisted in
    tools/baselines/enforcement/
  - Guard fails if UnsafeAny count increases above baseline
  - Guard passes if count is stable or decreasing
  - Adding a deliberate new UnsafeAny usage causes guard to fail
  - pnpm test --testNamePattern=type-safety-guard passes
locked: true
completed_at: 2026-02-24T20:14:46.156Z
completed: 2026-02-24
