id: WU-1729
title: Kernel ToolHost execution + EvidenceStore with CAS and receipts
lane: 'Framework: Core Lifecycle'
type: feature
status: done
priority: P0
created: 2026-02-16
code_paths:
  - packages/@lumenflow/kernel/src/tool-host/
  - packages/@lumenflow/kernel/src/evidence/
tests:
  manual:
    - pnpm typecheck passes for kernel package
  unit:
    - packages/@lumenflow/kernel/src/__tests__/tool-host.test.ts
    - packages/@lumenflow/kernel/src/__tests__/evidence-store.test.ts
  e2e: []
artifacts:
  - .lumenflow/stamps/WU-1729.done
dependencies: []
initiative: INIT-029
phase: 2
blocked_by:
  - WU-1728
  - WU-1726
labels:
  - kernel
  - phase-2
  - tool-host
  - evidence
spec_refs:
  - .claude/plans/golden-prancing-cookie.md
risks: []
notes: (auto) Add implementation notes, rollout context, or a short summary of the plan/conversation.
requires_review: false
assigned_to: tom@hellm.ai
exposure: backend-only
escalation_triggers: []
requires_human_escalation: false
requires_cso_approval: false
requires_cto_approval: false
requires_design_approval: false
description: 'Context: INIT-029 Phase 2 — ToolHost + Evidence. Depends on WU-1728 (ToolRegistry) and
  WU-1726 (EventStore). Problem: Tool execution needs a hard security boundary that validates
  scopes, enforces policy, and emits immutable evidence for replay determinism. Solution: Implement
  ToolHost as the execution boundary around ToolRegistry with fully working in-process execution.
  Add a SubprocessDispatcher port abstraction for subprocess execution, but keep worker integration
  out of scope for this WU (implemented in WU-1730). ToolHost is the single trace writer: writes
  tool_call_started before any dispatch attempt, writes tool_call_finished on success/failure/deny
  (including subprocess dispatch failures), and relies on reconciliation for orphaned started
  entries. Implement EvidenceStore JSONL append + CAS inputs with provenance fields and honest scope
  semantics. Reference: tool-runner.ts. Plan: .claude/plans/golden-prancing-cookie.md'
acceptance:
  - ToolHost class wraps ToolRegistry with execute(name, input, ctx) method
  - ToolHost validates input against tool schema before execution
  - 'ToolHost resolves scope intersection: workspace, lane, task, tool (all ToolScope[])'
  - ToolHost calls policy hook stub (allow-all for now, replaced in Phase 3)
  - In-process handlers execute through ToolHost and return validated output
  - Subprocess execution is abstracted behind a SubprocessDispatcher port interface (worker wiring
    deferred to WU-1730)
  - Default SubprocessDispatcher adapter returns explicit not-yet-available error until WU-1730 lands
  - 'Two-phase ToolTraceEntry: tool_call_started written BEFORE dispatch attempt, tool_call_finished
    AFTER result, correlated by receipt_id'
  - ToolTraceEntry includes schema_version:1 for stable control plane ingestion
  - 'ToolTraceEntry started includes honest scope semantics: scope_requested, scope_allowed,
    scope_enforced'
  - 'ToolTraceEntry started includes provenance: tool_version, pack_id, pack_version,
    pack_integrity, workspace_config_hash, runtime_version'
  - ToolTraceEntry finished includes scope_enforcement_note, policy_decisions, artifacts_written
  - 'Crash recovery: started entry without matching finished (by receipt_id) gets synthetic finished
    with result crashed'
  - EvidenceStore appends trace entries as JSONL to evidence/traces/
  - 'CAS store: tool inputs hashed with SHA-256 and stored in evidence/inputs/{hash}'
  - Execute within allowed scope (in-process) produces success trace with input_ref pointing to CAS
  - Execute outside allowed scope produces denied trace — hard boundary not hook
claimed_mode: worktree
worktree_path: /home/USER/source/hellmai/os/worktrees/framework-core-lifecycle-wu-1729
claimed_at: 2026-02-16T22:26:38.546Z
baseline_main_sha: ecd5b9a1305e744887ede8b3d30eaabb555b7ea4
session_id: d9f9c134-c455-4491-89f9-9b7499296407
approved_by:
  - tom@hellm.ai
approved_at: 2026-02-16T22:26:38.551Z
locked: true
completed_at: 2026-02-16T22:51:18.074Z
completed: 2026-02-16
