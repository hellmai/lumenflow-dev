id: WU-1471
title: Auto-checkpoint enforcement hooks + wu:done checkpoint gate
lane: 'Framework: CLI'
type: feature
status: in_progress
priority: P1
created: 2026-02-06
code_paths:
  - packages/@lumenflow/core/src/lumenflow-config-schema.ts
  - packages/@lumenflow/core/src/wu-constants.ts
  - packages/@lumenflow/cli/src/hooks/enforcement-generator.ts
  - packages/@lumenflow/cli/src/hooks/enforcement-sync.ts
  - packages/@lumenflow/cli/src/hooks/auto-checkpoint-utils.ts
  - packages/@lumenflow/cli/src/wu-done.ts
tests:
  manual:
    - Verify pnpm lumenflow:integrate generates auto-checkpoint.sh in .claude/hooks/ when memory.enforcement.auto_checkpoint.enabled=true
    - Verify wu:done warns (not blocks) when require_checkpoint_for_done=warn and no checkpoints exist
    - Verify wu:done blocks when require_checkpoint_for_done=block and no checkpoints exist
  unit:
    - packages/@lumenflow/core/src/__tests__/lumenflow-config-schema.test.ts
    - packages/@lumenflow/cli/src/__tests__/memory-integration.test.ts
  e2e: []
artifacts:
  - .lumenflow/stamps/WU-1471.done
dependencies: []
initiative: INIT-015
phase: 1
spec_refs:
  - lumenflow://plans/parsed-whistling-blanket.md
risks: []
notes: Implements WU-A from INIT-015 plan; keep behavior opt-in and fail-open.
requires_review: false
assigned_to: tom@hellm.ai
exposure: backend-only
escalation_triggers: []
requires_human_escalation: false
requires_cso_approval: false
requires_cto_approval: false
requires_design_approval: false
description: 'Context: checkpoint infrastructure exists but adoption is near zero. Problem:
  checkpointing is advisory, so recovery context is thin. Solution: add config-driven PostToolUse +
  async SubagentStop auto-checkpoint hooks, per-WU counter lifecycle, and configurable wu:done
  checkpoint gating with fail-open behavior.'
acceptance:
  - Integrate generates PostToolUse and async SubagentStop hooks when
    memory.enforcement.auto_checkpoint.enabled=true and hooks=true.
  - auto-checkpoint script branches on hook_event_name and backgrounds checkpoint writes using a
    defensive subshell.
  - wu:done supports memory.enforcement.require_checkpoint_for_done (warn by default, block when
    enabled).
  - wu:done cleanup removes .lumenflow/state/hook-counters/<WU_ID>.json for completed WUs.
  - When auto-checkpoint policy is enabled but hooks master switch is disabled, tooling emits a
    warning and remains advisory-only.
claimed_mode: worktree
worktree_path: /home/tom/source/hellmai/os/worktrees/framework-cli-wu-1471
claimed_at: 2026-02-06T11:29:32.679Z
baseline_main_sha: 394673552fc6b3783fd171ad9d23b100fa69489c
session_id: be97fe19-1536-4855-b8dd-563a5da44419
approved_by:
  - tom@hellm.ai
approved_at: 2026-02-06T11:29:32.685Z
