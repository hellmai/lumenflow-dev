id: WU-2275
title: Enforce vendor-agnostic workflow controls for wu:done, upgrade, and wu:edit
lane: 'Framework: CLI Enforcement'
type: bug
status: ready
priority: P1
created: 2026-02-28
code_paths:
  - packages/@lumenflow/cli/src/commands/wu-done.ts
  - packages/@lumenflow/cli/src/commands/lumenflow-upgrade.ts
  - packages/@lumenflow/cli/src/commands/pre-commit-check.ts
  - packages/@lumenflow/cli/src/commands/integrate.ts
  - packages/@lumenflow/cli/templates/core/.husky/pre-commit.template
  - packages/@lumenflow/cli/templates/core/.github/workflows/lumenflow-ci.yml.template
tests:
  manual:
    - Attempt wu:done on a WU claimed by another agent/session; verify block and verify --force
      override logs audit
    - Attempt raw @lumenflow version bump via package.json/pnpm-lock.yaml edit; verify pre-commit
      and CI fail without marker
    - Attempt direct docs/04-operations/tasks/wu/*.yaml edit; verify pre-commit and CI fail without
      wu:edit stamp
  unit:
    - packages/@lumenflow/cli/src/__tests__/wu-done.test.ts
    - packages/@lumenflow/cli/src/__tests__/lumenflow-upgrade.test.ts
    - packages/@lumenflow/cli/src/__tests__/init.test.ts
  e2e: []
artifacts:
  - .lumenflow/stamps/WU-2275.done
dependencies: []
risks: []
notes: ''
requires_review: false
assigned_to: tom@hellm.ai
exposure: backend-only
escalation_triggers: []
requires_human_escalation: false
requires_cso_approval: false
requires_cto_approval: false
requires_design_approval: false
description: 'Problem: agents bypass workflow by running raw @lumenflow package updates, directly
  editing WU YAML, or completing WUs they did not claim. Enforcement logic must live in the CLI so
  it propagates automatically on upgrade — scaffolded files (pre-commit, CI) should be stable
  one-liner delegators. Solution: (1) wu:done ownership check in CLI; (2) lumenflow:pre-commit-check
  CLI command containing all check logic; (3) thin .husky/pre-commit and CI templates that delegate
  to it; (4) lumenflow:integrate --sync migration for existing repos.'
acceptance:
  - wu:done blocks completion when current agent/session did not claim the WU, with a --force escape
    hatch and explicit audit event
  - lumenflow:upgrade writes an upgrade marker under .lumenflow/state/
  - 'lumenflow:pre-commit-check CLI command enforces: (a) @lumenflow/* version changes require
    upgrade marker, (b) WU YAML changes require wu:edit stamp'
  - "pre-commit template is a thin delegator: 'pnpm lumenflow:pre-commit-check' only — no logic in
    the script"
  - CI template calls the same lumenflow:pre-commit-check command so local hook bypasses cannot merge
  - wu:edit writes an edit stamp to wu-events.jsonl for each modified WU YAML path
  - lumenflow:integrate --sync re-scaffolds pre-commit and CI templates for existing repos without
    requiring a full re-init
