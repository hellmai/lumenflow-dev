id: WU-1624
title: Prevent local state divergence after failed wu:done recovery
lane: 'Framework: Core State Recovery'
type: bug
status: ready
priority: P1
created: 2026-02-13
code_paths:
  - packages/@lumenflow/core/src/wu-done-worktree.ts
  - packages/@lumenflow/cli/src/wu-done.ts
  - packages/@lumenflow/cli/src/wu-recover.ts
tests:
  manual:
    - Force a wu:done merge-failure path and verify main remains clean, then re-claim WU without manual git cleanup.
  unit:
    - packages/@lumenflow/core/src/__tests__/wu-done-rollback-leaks.test.ts
    - packages/@lumenflow/core/src/__tests__/wu-repair-core.test.ts
    - packages/@lumenflow/cli/src/__tests__/wu-done.test.ts
    - packages/@lumenflow/cli/src/__tests__/wu-claim-repair-guidance.test.ts
  e2e: []
artifacts:
  - .lumenflow/stamps/WU-1624.done
dependencies: []
risks: []
notes: 'Recurring incident: local .lumenflow/state/wu-events.jsonl drift after failed wu:done with recovery.'
requires_review: false
assigned_to: tom@hellm.ai
exposure: backend-only
escalation_triggers: []
requires_human_escalation: false
requires_cso_approval: false
requires_cto_approval: false
requires_design_approval: false
description: Failed wu:done completion paths can append lifecycle events locally and then roll back branch/worktree state, leaving main dirty and out of sync with origin. Subsequent wu:claim/wu:done operations get blocked by .lumenflow/state/wu-events.jsonl drift.
acceptance:
  - When wu:done fails after metadata/event writes, local main and origin/main remain consistent for wu-events state (no lingering dirty main from partial complete events).
  - Recovery path (wu:recover reset/resume) does not require manual git restore/pull before claiming the same WU again.
  - Regression coverage reproduces the failure path and proves state remains clean/consistent after rollback.
