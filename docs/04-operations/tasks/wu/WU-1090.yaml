id: WU-1090
title: Context-aware state machine for WU lifecycle commands
lane: 'Framework: Core'
type: feature
status: done
priority: P2
created: 2026-01-24
code_paths:
  - packages/@lumenflow/core/src/context/
  - packages/@lumenflow/core/src/validation/
  - packages/@lumenflow/core/src/recovery/
  - packages/@lumenflow/core/src/lumenflow-config-schema.ts
  - packages/@lumenflow/core/src/wu-constants.ts
  - CLAUDE.md
  - LUMENFLOW.md
tests:
  manual:
    - CLI integration (wu:status, wu:recover) deferred to follow-up WU
  unit:
    - packages/@lumenflow/core/src/__tests__/context/
    - packages/@lumenflow/core/src/__tests__/validation/
    - packages/@lumenflow/core/src/__tests__/recovery/
artifacts:
  - .lumenflow/stamps/WU-1090.done
dependencies: []
spec_refs:
  - internal
risks:
  - Performance regression if context computation exceeds 100ms threshold
  - Breaking change if validation_mode defaults to error too early
notes: |
  ## Library-First Mandate
  Use existing dependencies only: zod, simple-git, chalk, change-case.
  Do NOT add XState - extend existing state-machine.ts pattern.

  ## Code Quality Mandates
  - TDD: Write failing tests FIRST (red-green-refactor)
  - SOLID: Single responsibility per module
  - DRY: All constants in wu-constants.ts
  - KISS/YAGNI: Simplest solution that works
requires_review: true
assigned_to: tom@hellm.ai
exposure: backend-only
escalation_triggers: []
requires_human_escalation: false
requires_cso_approval: false
requires_cto_approval: false
requires_design_approval: false
description: |
  Implement a context-aware state machine for WU lifecycle commands to eliminate agents
  executing commands without understanding their current context (location, WU state, git state),
  leading to failures, retry loops, and corrupted repository states.

  The solution provides:
  1. Unified context model capturing all relevant environmental state
  2. Declarative command requirements specifying what each command needs
  3. Smart validation that guides rather than just rejects
  4. Recovery paths for every failure mode
  5. Vendor-agnostic design with no agent-specific assumptions
acceptance:
  - WuContext interface captures location, git, wu, lane, and session state
  - resolveLocation() correctly detects main vs worktree using simple-git
  - resolveLocation() extracts WU ID from worktree path using PATTERNS constant
  - readGitState() returns branch, dirty, staged, ahead/behind using simple-git
  - readWuState() queries both YAML and state store, detects inconsistencies
  - computeContext() completes in < 100ms (performance budget)
  - CommandDefinition interface with requiredLocation, requiredWuStatus, predicates
  - COMMAND_REGISTRY contains all wu:* commands (create, claim, done, block, unblock, status,
    recover)
  - validateCommand() returns ValidationResult with errors, warnings, context
  - Location validation rejects wrong location with copy-paste fix command
  - Status validation rejects wrong WU status with guidance
  - Predicate system supports custom checks with severity (error/warning)
  - Fix commands are copy-paste ready with actual paths from context
  - getValidCommandsForContext() returns commands valid for current state
  - Success output includes relevant next steps
  - analyzeRecovery() detects partial claim, orphan claim, inconsistent state, orphan branch, stale
    lock
  - Recovery actions resume (preserves work), reset (discards worktree), nuke (requires --force)
  - All recovery actions are idempotent
  - wu:status shows location, WU state, git state, valid commands
  - wu:recover analyzes issues and offers recovery actions
  - Feature flags in .lumenflow.config.yaml (context_validation, validation_mode, show_next_steps)
  - Validation integrated into wu:create, wu:claim, wu:done
  - validation_mode supports off, warn, error
  - All git operations use simple-git (NOT execSync)
  - All constants in wu-constants.ts CONTEXT_VALIDATION section
  - No magic numbers or hardcoded strings in implementation
  - 95%+ unit test coverage on context, validation, recovery modules
  - CLAUDE.md updated with wu:status and wu:recover commands
  - LUMENFLOW.md updated with validation behavior description
claimed_mode: worktree
worktree_path: /home/tom/source/hellmai/os/worktrees/framework-core-wu-1090
claimed_at: 2026-01-24T19:26:37.883Z
baseline_main_sha: d6b7bce9afbb223ceab66f5b05e7d84a818831d1
session_id: 575b550d-dc23-4924-ad87-f5848b704a94
approved_by:
  - tom@hellm.ai
approved_at: 2026-01-24T19:26:37.890Z
locked: true
completed_at: 2026-01-24T19:51:47.644Z
