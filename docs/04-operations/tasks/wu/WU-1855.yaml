id: WU-1855
title: Close MCP literal governance blind spots and enforce full constant coverage
lane: 'Framework: MCP'
type: bug
status: ready
priority: P0
created: 2026-02-18
code_paths:
  - packages/@lumenflow/mcp/src/mcp-constants.ts
  - packages/@lumenflow/mcp/src/runtime-tool-resolver.ts
  - packages/@lumenflow/mcp/src/tools/parity-tools.ts
  - packages/@lumenflow/mcp/src/__tests__/literal-governance.test.ts
  - packages/@lumenflow/mcp/src/__tests__/runtime-tool-resolver.test.ts
  - packages/@lumenflow/mcp/src/tools-shared.ts
tests:
  manual:
    - Verify representative MCP tools (wu_status, state_doctor, git_status) still return unchanged
      success/error shapes and CLI dispatch behavior.
  unit:
    - packages/@lumenflow/mcp/src/__tests__/literal-governance.test.ts
    - packages/@lumenflow/mcp/src/__tests__/runtime-tool-resolver.test.ts
    - packages/@lumenflow/mcp/src/__tests__/tools.test.ts
  e2e: []
artifacts:
  - .lumenflow/stamps/WU-1855.done
dependencies: []
initiative: INIT-030
phase: 3
spec_refs:
  - /home/USER/.claude/plans/adaptive-finding-adleman.md
  - /home/USER/.claude/plans/zesty-jumping-pixel.md
risks: []
notes: 'Tightening WU-1851 residuals to 100% governance: close declaration-level blind spots and
  eliminate hidden duplicates. Keep scope MCP-only; do not expand into unrelated kernel/package
  surfaces.'
requires_review: false
assigned_to: tom@hellm.ai
exposure: backend-only
escalation_triggers: []
requires_human_escalation: false
requires_cso_approval: false
requires_cto_approval: false
requires_design_approval: false
description: 'Context: WU-1851 established MCP constant governance, but residual raw governed
  literals still exist in runtime/parity internals and the ratchet test currently excludes some of
  those patterns. Problem: the current ratchet can pass while governed drift remains, weakening
  enterprise-grade contract enforcement. Solution: eliminate remaining governed literal duplicates,
  tighten the guardrail to detect declaration-level drift (not only call sites), and codify explicit
  allowlist-only exceptions with auditability.'
acceptance:
  - 'Replace the remaining raw governed literals identified post-WU-1851 in MCP production code:
    runtime-tool-resolver command map literals and project_root metadata-key aliases in
    parity/runtime modules, using mcp-constants.ts constants (or explicit file-scoped allowlist with
    justification).'
  - literal-governance.test.ts enforces governed literals in both execution call sites and
    declaration/assignment contexts (const maps, const aliases, fallback.command,
    executeViaPack/runCliCommand arguments).
  - Remove blanket skip heuristics from the ratchet (e.g., line-contains RUNTIME_PROJECT_ROOT). Any
    exception must be declared in an explicit allowlist keyed by file and literal with rationale.
  - Guardrail includes runtime-tool-resolver.ts and parity-tools.ts and fails when any newly
    introduced raw governed command-name/metadata-key/shared-flag literal appears in those files.
  - 'Guardrail remains scoped: only governed families are blocked; tool-local non-governed literals
    remain allowed.'
  - Add/adjust unit tests to prove REDâ†’GREEN behavior for the ratchet against at least one
    declaration-level violation case and one allowed exception case.
  - No behavior/output regressions for representative MCP tools (wu_status, state_doctor,
    git_status) after constant replacement.
  - No public API changes to @lumenflow/mcp exports; refactor remains internal.
  - pnpm gates passes.
