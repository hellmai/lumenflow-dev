id: WU-1665
title: Consolidate wu:done rollback and recovery onto staged state-machine migration
lane: 'Framework: Core State Recovery'
type: refactor
status: ready
priority: P1
created: 2026-02-13
code_paths:
  - packages/@lumenflow/core/src/wu-recovery.ts
  - packages/@lumenflow/core/src/wu-transaction.ts
  - packages/@lumenflow/core/src/rollback-utils.ts
  - packages/@lumenflow/core/src/__tests__/wu-done-worktree.test.ts
  - packages/@lumenflow/core/src/__tests__/atomic-merge.test.ts
tests:
  manual:
    - Exercise representative failure injections (push success/local drift, cleanup partials, retry paths) and verify deterministic recovery outcomes.
  unit:
    - packages/@lumenflow/core/src/__tests__/wu-done-worktree.test.ts
    - packages/@lumenflow/core/src/__tests__/atomic-merge.test.ts
  e2e: []
artifacts:
  - .lumenflow/stamps/WU-1665.done
dependencies: []
initiative: INIT-025
phase: 1
blocked_by:
  - WU-1663
  - WU-1664
spec_refs:
  - lumenflow://plans/INIT-025-plan.md
  - docs/04-operations/_frameworks/lumenflow/wu-sizing-guide.md
risks: []
notes: 'Sizing (wu-sizing-guide): Medium/Complex boundary due high-risk failure semantics; run checkpoint-resume workflow and keep file/tool-call triggers under active monitoring.'
requires_review: false
assigned_to: tom@hellm.ai
exposure: backend-only
escalation_triggers: []
requires_human_escalation: false
requires_cso_approval: false
requires_cto_approval: false
requires_design_approval: false
description: 'Context: wu:done recovery currently spans multiple rollback mechanisms (transaction abort, snapshots, branch rollback, zombie recovery), increasing failure-path complexity and drift risk. Problem: overlapping recovery channels create inconsistent semantics and high maintenance burden. Solution: consolidate rollback/recovery around the state-machine model with a staged migration approach (default new path plus temporary legacy fallback) and comprehensive failure-mode coverage.'
acceptance:
  - Default rollback/recovery path uses state-machine-driven semantics with serialized snapshot restore capabilities.
  - Legacy recovery path remains available behind an explicit temporary compatibility switch during migration window.
  - Failure-mode tests demonstrate parity or improvement versus pre-migration behavior across previously flaky/zombie-prone paths.
  - Rollback/recovery responsibilities are centralized and documented; duplicate mechanism overlap is removed or deprecated.
