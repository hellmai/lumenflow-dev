id: WU-1142
title: Make wu:spawn prompts type-aware for testing requirements
lane: 'Framework: CLI'
type: tooling
status: in_progress
priority: P2
created: 2026-01-27
code_paths:
  - packages/@lumenflow/cli/src/wu-spawn.ts
  - packages/@lumenflow/cli/templates/
  - packages/@lumenflow/core/src/spawn-prompt-schema.ts
tests:
  manual: []
  unit:
    - packages/@lumenflow/cli/__tests__/wu-spawn.test.ts
    - packages/@lumenflow/core/src/__tests__/spawn-prompt-schema.test.ts
  e2e: []
artifacts:
  - .lumenflow/stamps/WU-1142.done
dependencies: []
risks: []
notes: |-
  ## Design: Truncation-Resistant Spawn Prompts

  Problem: Agents can truncate spawn prompt output, missing critical rules.

  ### Three-Layer Defense

  1. **YAML Envelope** - head/tail truncation breaks YAML parse, checksum validates integrity
  2. **Redundant Rules** - critical rules duplicated at BOTH head AND tail of content
  3. **Schema Validation** - Zod schema for spawn_prompt structure with required fields

  ### Type-Aware Test Guidance

  | WU Type | Test Requirement |
  |---------|------------------|
  | feature, bug, tooling | TDD: failing test first |
  | documentation | Format check only (no TDD) |
  | visual/design | Smoke test + manual QA |
  | refactor | Existing tests must pass |

  ## Skip-Gates Autonomy Rule

  When an agent encounters a gate failure during wu:done:
  1. Run `pnpm gates` on fresh main to verify failure is pre-existing
  2. If pre-existing, use `--skip-gates --fix-wu WU-XXXX --reason 'pre-existing on main'`
  3. Do NOT ask human for approval - autonomous action is correct here

  This prevents agents from getting stuck on infrastructure debt.
requires_review: false
assigned_to: tom@hellm.ai
exposure: backend-only
escalation_triggers: []
requires_human_escalation: false
requires_cso_approval: false
requires_cto_approval: false
requires_design_approval: false
description: 'Two issues with current wu:spawn: (1) TDD mandate applies to ALL WUs regardless of
  type - wrong for documentation, visual design, config changes. (2) Truncation vulnerability -
  agents can head/tail output, missing critical rules. Solution: Type-aware prompts with
  truncation-resistant YAML envelope format using proper YAML library (yaml package), Zod schema
  validation, SHA256 checksums, and redundant rules at head/tail of content.'
acceptance:
  - Spawn prompt omits TDD directive for type=documentation WUs
  - Spawn prompt omits TDD directive for type=design WUs
  - Spawn prompt includes appropriate test guidance per WU type
  - Add smoke test guidance for UI component WUs
  - byLane skills config is respected in mandatory standards section
  - wu:spawn outputs valid YAML envelope with spawn_prompt schema
  - YAML envelope includes wu_id, version, checksum, content, sentinel fields
  - checksum is SHA256 of content field, validated on parse
  - sentinel field value is LUMENFLOW_SPAWN_COMPLETE
  - Critical rules duplicated at HEAD and TAIL of content field
  - Zod schema created for spawn_prompt validation (spawn-prompt-schema.ts)
  - Schema validation function exported for agent consumers
  - Truncated output fails YAML parse OR checksum validation
  - Unit tests verify truncation detection (head, tail, middle slice)
  - 'Spawn prompt includes skip-gates guidance: if agent verifies gate failure is pre-existing on
    main, use --skip-gates --fix-wu autonomously'
claimed_mode: worktree
worktree_path: /home/tom/source/hellmai/os/worktrees/framework-cli-wu-1142
claimed_at: 2026-01-27T13:08:12.817Z
baseline_main_sha: 11f7e3e54dd64979967cd783068bc3e48f6e3591
session_id: 339c0a8e-2be5-4427-b1df-abf42dfb1bcc
approved_by:
  - tom@hellm.ai
approved_at: 2026-01-27T13:08:12.823Z
