id: WU-1730
title: Kernel sandbox integration (bwrap port) + subprocess tool-runner worker
lane: 'Framework: Core Validation'
type: feature
status: ready
priority: P1
created: 2026-02-16
code_paths:
  - packages/@lumenflow/kernel/src/sandbox/
tests:
  manual:
    - bwrap available on system and sandbox tests pass
  unit:
    - packages/@lumenflow/kernel/src/__tests__/sandbox.test.ts
    - packages/@lumenflow/kernel/src/__tests__/tool-runner-worker.test.ts
  e2e: []
artifacts:
  - .lumenflow/stamps/WU-1730.done
dependencies: []
initiative: INIT-029
phase: 2
blocked_by:
  - WU-1729
labels:
  - kernel
  - phase-2
  - sandbox
spec_refs:
  - .claude/plans/golden-prancing-cookie.md
risks: []
notes: (auto) Add implementation notes, rollout context, or a short summary of the plan/conversation.
requires_review: false
assigned_to: tom@hellm.ai
exposure: backend-only
escalation_triggers: []
requires_human_escalation: false
requires_cso_approval: false
requires_cto_approval: false
requires_design_approval: false
description: 'Context: INIT-029 Phase 2 â€” ToolHost + Evidence. Depends on WU-1729 (ToolHost).
  Problem: Subprocess tools need OS-level isolation via bwrap and a shared execution worker, but
  receipt ownership must remain unambiguous to preserve append-only evidence invariants. Solution:
  Port sandbox-backend-linux.ts bwrap invocation builder into kernel/sandbox and implement the
  tool-runner worker that receives serialized invocations, loads handler.entry adapters, executes
  inside sandbox, and returns structured results/errors. Wire this worker into the
  SubprocessDispatcher port introduced in WU-1729. ToolHost remains the single evidence writer
  (started/finished entries); worker never writes trace files directly. v1 security stance remains:
  write confinement guaranteed, read confinement best-effort, network posture off/full. Reference:
  sandbox-backend-linux.ts. Plan: .claude/plans/golden-prancing-cookie.md'
acceptance:
  - Bwrap invocation builder ported from sandbox-backend-linux.ts into kernel/sandbox/
  - SandboxProfile type defines ro-bind, writable bind mounts, network posture (off|full), deny
    overlays, env vars
  - Worker receives serialized invocation payload (tool_name, input, scope_enforced, receipt_id) via
    stdin/IPC
  - Worker loads tool adapter via handler.entry string (not direct import from surfaces/packs)
  - Worker executes adapter inside bwrap sandbox and returns structured ToolOutput/error metadata
    via stdout/IPC
  - SubprocessDispatcher implementation is wired into ToolHost port from WU-1729
  - Worker does NOT write tool trace files directly; ToolHost remains single writer for
    tool_call_started/tool_call_finished
  - Spawn/transport failures propagate structured errors so ToolHost can emit tool_call_finished
    with failure
  - Subprocess runs inside bwrap with --die-with-parent and --new-session
  - 'Write confinement enforced: only resolved write scope mounted as rw'
  - Deny overlays block ~/.ssh, ~/.aws, ~/.gnupg, .env from sandbox reads
  - scope_enforcement_note set to read confinement best-effort v1 when applicable
