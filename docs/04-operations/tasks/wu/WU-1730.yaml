id: WU-1730
title: Kernel sandbox integration (bwrap port) + subprocess tool-runner worker
lane: 'Framework: Core Validation'
type: feature
status: ready
priority: P1
created: 2026-02-16
code_paths:
  - packages/@lumenflow/kernel/src/sandbox/
tests:
  manual:
    - bwrap available on system and sandbox tests pass
  unit:
    - packages/@lumenflow/kernel/src/__tests__/sandbox.test.ts
    - packages/@lumenflow/kernel/src/__tests__/tool-runner-worker.test.ts
  e2e: []
artifacts:
  - .lumenflow/stamps/WU-1730.done
dependencies: []
initiative: INIT-029
phase: 2
blocked_by:
  - WU-1729
labels:
  - kernel
  - phase-2
  - sandbox
spec_refs:
  - .claude/plans/golden-prancing-cookie.md
risks: []
notes: (auto) Add implementation notes, rollout context, or a short summary of the plan/conversation.
requires_review: false
assigned_to: tom@hellm.ai
exposure: backend-only
escalation_triggers: []
requires_human_escalation: false
requires_cso_approval: false
requires_cto_approval: false
requires_design_approval: false
description: 'Context: INIT-029 Phase 2 â€” ToolHost + Evidence. Depends on WU-1729 (ToolHost).
  Problem: Subprocess tools need OS-level isolation via bwrap sandbox, and receipts must survive
  host crashes (crash-gap fix). Solution: Port sandbox-backend-linux.ts bwrap invocation builder
  into kernel/sandbox/. Implement tool-runner worker that: receives {tool_name, input,
  scope_enforced, receipt_id} via stdin, writes a started receipt BEFORE execution (crash-gap
  guarantee), loads tool adapter via handler.entry (pack-provided), executes in sandbox, writes
  final receipt, returns ToolOutput via stdout. Worker writes receipts inside sandbox so evidence
  exists even if host dies mid-flight. v1 security stance: write confinement guaranteed (bwrap rw
  bind), read confinement best-effort (deny overlays for ~/.ssh etc), network binary off/full.
  Reference: sandbox-backend-linux.ts. Plan: .claude/plans/golden-prancing-cookie.md'
acceptance:
  - Bwrap invocation builder ported from sandbox-backend-linux.ts into kernel/sandbox/
  - SandboxProfile type defines ro-bind, writable bind mounts, network posture (off|full), deny
    overlays, env vars
  - Worker receives {tool_name, input, scope_enforced, receipt_id} via stdin
  - Worker writes started receipt BEFORE execution (crash-gap guarantee)
  - Worker loads tool adapter via handler.entry string (not direct import)
  - Worker writes final receipt (success/failure/denied) with same receipt_id
  - Worker returns structured ToolOutput via stdout
  - Subprocess runs inside bwrap with --die-with-parent and --new-session
  - 'Write confinement enforced: only resolved write scope mounted as rw'
  - Deny overlays block ~/.ssh, ~/.aws, ~/.gnupg, .env from sandbox reads
  - scope_enforcement_note set to read confinement best-effort v1 when applicable
