id: WU-1859
title: 'INIT-030 Review Fix A: executeViaPack policy bypass security fix'
lane: 'Framework: MCP'
type: bug
status: done
priority: P1
created: 2026-02-18
code_paths:
  - packages/@lumenflow/mcp/src/tools-shared.ts
tests:
  manual:
    - Mock deny policy, call executeViaPack, verify NO CLI fallback
  unit:
    - packages/@lumenflow/mcp/src/__tests__/tools-shared.test.ts
  e2e: []
artifacts:
  - .lumenflow/stamps/WU-1859.done
dependencies: []
initiative: INIT-030
phase: 5
risks: []
notes: Added NON_FALLBACK_ERROR_CODES set (POLICY_DENIED, SCOPE_DENIED, SPEC_TAMPERED) to
  executeViaPack. These kernel enforcement errors are returned directly without CLI fallback.
  TOOL_NOT_FOUND and runtime init failures still trigger fallback for backward compat.
  DEFAULT_MAINTENANCE_SCOPE narrowed from wildcard write to read-only. runtime-cache.ts did not
  require changes -- removed from code_paths.
requires_review: false
assigned_to: tom@hellm.ai
exposure: backend-only
escalation_triggers: []
requires_human_escalation: false
requires_cso_approval: false
requires_cto_approval: false
requires_design_approval: false
description: Code review of INIT-030 found that executeViaPack falls back to CLI on policy/scope
  denials, bypassing the kernel policy enforcement layer. Also fixes workspace hash cascade and
  wildcard maintenance scope.
acceptance:
  - Policy/scope denials from kernel returned directly, never retried via CLI
  - SPEC_TAMPERED errors returned directly, never retried via CLI
  - Runtime init failures still trigger CLI fallback (backward compat)
  - TOOL_NOT_FOUND still triggers CLI fallback (migration compat)
  - Maintenance scope narrowed from wildcard write
  - New tests cover all 4 fallback/no-fallback scenarios
claimed_mode: worktree
worktree_path: /home/tom/source/hellmai/os/worktrees/framework-mcp-wu-1859
claimed_at: 2026-02-18T22:10:10.925Z
baseline_main_sha: 1730f7c25b2c8cc3103a6b5b26e55125966307ca
session_id: 992ec8f4-036f-445c-853c-97fcabb1e7c4
approved_by:
  - tom@hellm.ai
approved_at: 2026-02-18T22:10:10.929Z
locked: true
completed_at: 2026-02-18T22:23:46.535Z
completed: 2026-02-18
