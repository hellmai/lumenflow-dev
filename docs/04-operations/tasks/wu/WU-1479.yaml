id: WU-1479
title: Fix wu:done push race condition and add provenance trailers
lane: 'Framework: Core'
type: bug
status: ready
priority: P2
created: 2026-02-06
code_paths:
  - packages/@lumenflow/core/src/wu-done-worktree.ts
  - packages/@lumenflow/core/src/wu-done-metadata.ts
  - packages/@lumenflow/core/src/wu-done-branch-only.ts
  - packages/@lumenflow/core/src/wu-constants.ts
tests:
  manual: []
  unit:
    - packages/@lumenflow/core/src/__tests__/wu-done-preflight.test.ts
  e2e: []
artifacts:
  - .lumenflow/stamps/WU-1479.done
dependencies: []
spec_refs:
  - lumenflow://plans/declarative-forging-pixel.md
risks: []
notes: 'Root cause: WU-1467 push race condition. Plan: declarative-forging-pixel.md. New test file needed for generateCommitMessage provenance.'
requires_review: false
assigned_to: tom@hellm.ai
exposure: backend-only
escalation_triggers: []
requires_human_escalation: false
requires_cso_approval: false
requires_cto_approval: false
requires_design_approval: false
description: 'wu:done push step has no retry/sync logic. When origin/main advances between merge and push (concurrent agents), push fails with non-fast-forward. Agents improvise recovery with LUMENFLOW_FORCE, creating ghost commits. Fix: git pull --rebase before push (standard git pattern). Add provenance trailers for forensics.'
acceptance:
  - wu:done push succeeds when origin/main advances between merge and push
  - No error swallowing - rebase conflicts propagate clearly
  - Provenance trailers (Worktree-Branch, Worktree-Path) in wu:done commits
  - No hardcoded string literals - uses GIT_COMMANDS/GIT_FLAGS constants
  - All existing tests pass
