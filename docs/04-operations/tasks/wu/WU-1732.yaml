id: WU-1732
title: Kernel PolicyEngine + DomainPack manifest/loader + integrity pinning
lane: 'Framework: Core Validation'
type: feature
status: ready
priority: P1
created: 2026-02-16
code_paths:
  - packages/@lumenflow/kernel/src/policy/
  - packages/@lumenflow/kernel/src/pack/
tests:
  manual:
    - pnpm typecheck passes for kernel package
  unit:
    - packages/@lumenflow/kernel/src/__tests__/policy-engine.test.ts
    - packages/@lumenflow/kernel/src/__tests__/pack-loader.test.ts
  e2e: []
artifacts:
  - .lumenflow/stamps/WU-1732.done
dependencies: []
initiative: INIT-029
phase: 3
blocked_by:
  - WU-1729
labels:
  - kernel
  - phase-3
  - policy
  - packs
spec_refs:
  - .claude/plans/golden-prancing-cookie.md
risks: []
notes: (auto) Add implementation notes, rollout context, or a short summary of the plan/conversation.
requires_review: false
assigned_to: tom@hellm.ai
exposure: backend-only
escalation_triggers: []
requires_human_escalation: false
requires_cso_approval: false
requires_cto_approval: false
requires_design_approval: false
description: 'Context: INIT-029 Phase 3 — Policies + Packs. Depends on WU-1729 (ToolHost). Problem:
  The kernel needs a pluggable policy system (deny-wins cascade) and a pack loading mechanism with
  integrity verification that is strong enough to detect meaningful pack drift. Solution:
  PolicyEngine class with cascade evaluation (workspace -> lane -> pack -> task), deny-wins
  semantics, four trigger points (on_tool_request, on_claim, on_completion, on_evidence_added).
  DomainPack manifest schema (Zod) defining tools, policies, evidence_types, state_aliases,
  lane_templates. Pack loader resolves from workspace config using PackPin (id, version, integrity,
  source). Integrity verification: dev mode logs warning; sha256 mode hashes all files under pack
  root (with deterministic ordering/exclusions) before registration. Enforce pack import boundaries
  so pack code cannot import workspace-local modules outside pack root except @lumenflow/kernel and
  Node built-ins. Approvals as typed events with run_id + scope + expiry. Threat model note: packs
  are trusted code (approved by workspace admin) — the system prevents agents going off-script, not
  malicious pack authors. Plan: .claude/plans/golden-prancing-cookie.md'
acceptance:
  - 'PolicyEngine class with cascade evaluation: workspace -> lane -> pack -> task-specific'
  - 'Deny-wins semantics: deny at any level overrides allow from other levels'
  - Lower levels tighten only — loosening requires explicit opt-in
  - 'Four trigger points: on_tool_request, on_claim, on_completion, on_evidence_added'
  - 'DomainPack manifest Zod schema: id, version, task_types, tools, policies, evidence_types,
    state_aliases'
  - Pack loader resolves pack from workspace config and verifies SHA-256 integrity hash
  - Tampered pack (wrong hash) is rejected at load time
  - 'ApprovalEvent schema: typed events with run_id, scope, expires_at'
  - Pack loader resolves from workspace PackPin entries (id, version, integrity, source)
  - 'Deterministic pack hashing: sorted file paths, per-file SHA-256, null-byte delimited concat,
    final SHA-256'
  - 'Dev mode (integrity: dev) skips verification but logs workspace_warning event'
  - Deterministic pack hashing covers all files under pack root
    (packages/@lumenflow/packs/<pack-id>/**) except explicit exclusions
  - Boundary rules prevent pack imports of workspace-local modules outside pack root (except
    @lumenflow/kernel and Node built-ins)
