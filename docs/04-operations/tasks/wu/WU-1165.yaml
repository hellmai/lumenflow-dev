id: WU-1165
title: 'Bug: incremental tests run full suite'
lane: 'Framework: CLI'
type: bug
status: done
priority: P1
created: 2026-01-28
code_paths:
  - packages/@lumenflow/cli/src/gates.ts
tests:
  manual:
    - Run pnpm gates on a worktree with a single file change in packages/@lumenflow/cli and verify
      only relevant format/lint/test steps run
  unit:
    - packages/@lumenflow/cli/__tests__/gates.test.ts
  e2e: []
artifacts:
  - .lumenflow/stamps/WU-1165.done
dependencies: []
risks: []
notes: Completed per acceptance criteria.
requires_review: false
assigned_to: tom@hellm.ai
exposure: backend-only
escalation_triggers: []
requires_human_escalation: false
requires_cso_approval: false
requires_cto_approval: false
requires_design_approval: false
description: "Context: Gates currently run full-repo format checks and full test suites in
  worktrees, despite advertising incremental behavior. Problem: format:check runs Prettier against
  '.', tests always run 'turbo run test', and linting only targets apps/web, so worktree gates are
  slow and inconsistent. Solution: make gates use changed-file/package awareness for format, lint,
  and tests with safe fallbacks to full runs; keep global consistency validators full-repo and
  preserve default behavior on main."
acceptance:
  - Format check runs Prettier only on changed files (skip when none), with full-repo fallback if
    Prettier config/ignore changes or file list cannot be determined
  - Lint gate runs only for affected packages/paths (apps/*, packages/*); full lint on main or when
    incremental detection fails
  - Test gate runs incremental tests (Vitest --changed or equivalent) when possible; falls back to
    full suite on untracked code/config changes or detection failure
  - Global consistency validators (spec-linter, backlog sync, system map) remain full-repo
  - Unit tests updated to cover incremental vs fallback paths for format, lint, and tests
claimed_mode: worktree
worktree_path: /home/tom/source/hellmai/os/worktrees/framework-cli-wu-1165
claimed_at: 2026-01-28T11:20:57.313Z
baseline_main_sha: 1afe64d12c216270f208eba484f365f8df012a96
session_id: 852fff34-1ca3-4627-81dd-41dd7408508e
approved_by:
  - tom@hellm.ai
approved_at: 2026-01-28T11:20:57.318Z
locked: true
completed_at: 2026-01-28T11:56:10.394Z
