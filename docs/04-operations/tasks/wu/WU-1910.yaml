id: WU-1910
title: Fix loadMemory deduplication â€” archived nodes not suppressing originals
lane: 'Framework: Memory'
type: bug
status: in_progress
priority: P2
created: 2026-02-19
code_paths:
  - packages/@lumenflow/memory/src/memory-store.ts
  - packages/@lumenflow/memory/src/mem-triage-core.ts
tests:
  manual:
    - Run mem:triage --archive on a discovery, then mem:triage --list, verify node no longer appears
  unit:
    - packages/@lumenflow/memory/__tests__/memory-store.test.ts
    - packages/@lumenflow/memory/__tests__/mem-triage-core.test.ts
  e2e: []
artifacts:
  - .lumenflow/stamps/WU-1910.done
dependencies: []
risks: []
notes: (auto) Add implementation notes, rollout context, or a short summary of the plan/conversation.
requires_review: false
assigned_to: tom@hellm.ai
exposure: backend-only
escalation_triggers: []
requires_human_escalation: false
requires_cso_approval: false
requires_cto_approval: false
requires_design_approval: false
description: "loadMemory() in memory-store.ts skips archived entries entirely (continue on line 248)
  when includeArchived=false. This means the archived version never overwrites the original in byId,
  so the original non-archived entry persists in both nodes[] and byId. Result: mem:triage --archive
  succeeds (appends archived entry to JSONL) but mem:triage --list still shows the node as open. The
  fix: loadMemory should process ALL entries for byId deduplication (last-write-wins), then filter
  archived nodes from the final result. The TODO on mem-triage-core.ts:336 acknowledges this: 'we'd
  need deduplication on load'."
acceptance:
  - loadMemory deduplicates by node ID using last-write-wins before filtering
  - Archived entries suppress their original non-archived versions in nodes[] and byId
  - mem:triage --archive followed by mem:triage --list no longer shows the archived node
  - byId always contains the latest version of each node regardless of archive status
  - includeArchived=false still excludes archived nodes from final result
  - Existing loadMemory tests updated, new test for archive-then-list round-trip
  - Remove TODO comment from mem-triage-core.ts:336
claimed_mode: worktree
worktree_path: /home/USER/source/hellmai/os/worktrees/framework-memory-wu-1910
claimed_at: 2026-02-19T19:15:03.145Z
baseline_main_sha: 46bf6e5805e16073610f8480f8976306856df377
session_id: 7abc3d14-c171-43ec-b233-a64aac21cc40
approved_by:
  - tom@hellm.ai
approved_at: 2026-02-19T19:15:03.148Z
