id: WU-1612
title: PostToolUse hook to track agent launches for compaction recovery
lane: 'Framework: CLI Enforcement'
type: feature
status: in_progress
priority: P2
created: 2026-02-12
code_paths:
  - .claude/hooks/track-agent-launch.sh
  - .claude/settings.json
tests:
  manual:
    - Simulate PostToolUse Task hook input with agent_id and verify signal appears in mem:inbox.
    - Verify hook exits 0 and does not block when no agent_id is present.
    - Verify hook is a no-op when not in a worktree (no WU in branch name).
  unit: []
  e2e: []
artifacts:
  - .lumenflow/stamps/WU-1612.done
dependencies: []
spec_refs:
  - lumenflow://conversation/agent-compaction-recovery
risks: []
notes: >-
  Single new hook script (track-agent-launch.sh) + one settings.json entry.
  Uses existing mem:signal bus — no new state files. WU ID detected from git
  branch name (fast, no pnpm dependency). Signal is synchronous with 5s timeout
  to ensure delivery without blocking. Tested with dict and string tool_response
  formats, foreground and background agents, and missing agent_id edge case.
requires_review: false
assigned_to: tom@hellm.ai
exposure: backend-only
escalation_triggers: []
requires_human_escalation: false
requires_cso_approval: false
requires_cto_approval: false
requires_design_approval: false
description: Add a PostToolUse hook on Task tool that writes a mem:signal recording each agent
  launch (ID, description, subagent type). The existing PreCompact and SessionStart hooks already
  surface signals in recovery context, so this single hook closes the gap where compacted agents
  forget their running sub-agents.
acceptance:
  - PostToolUse hook fires on Task tool calls and records agent ID + description via mem:signal
  - After compaction, recovery context includes active agent IDs from signals
  - No new state files — uses existing signal bus
  - Hook is informational only (exit 0, never blocks)
claimed_mode: worktree
worktree_path: /home/USER/source/hellmai/os/worktrees/framework-cli-enforcement-wu-1612
claimed_at: 2026-02-12T15:38:16.607Z
baseline_main_sha: 9cb8bf474fc6cb090f55d0ac7524b2f8134db2dc
session_id: c22b2f5c-09e5-4a8e-8f25-bd395adc9df0
approved_by:
  - tom@hellm.ai
approved_at: 2026-02-12T15:38:16.612Z
