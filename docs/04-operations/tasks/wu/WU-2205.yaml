id: WU-2205
title: 'Phase 5: Simplify wu:done sync checks to canonical not-behind semantics'
lane: 'Framework: Core Lifecycle'
type: refactor
status: ready
priority: P1
created: 2026-02-26
code_paths:
  - packages/@lumenflow/cli/src/wu-done.ts
  - packages/@lumenflow/cli/src/wu-done-git-ops.ts
  - packages/@lumenflow/core/src/wu-done-main-sync.ts
  - packages/@lumenflow/core/src/wu-done-worktree.ts
  - packages/@lumenflow/core/src/wu-done-worktree-services.ts
tests:
  manual: []
  unit:
    - packages/@lumenflow/core/src/__tests__/wu-done-rollback-leaks.test.ts
    - packages/@lumenflow/core/src/__tests__/wu-done-worktree-services.test.ts
    - packages/@lumenflow/cli/src/__tests__/wu-done.test.ts
    - packages/@lumenflow/cli/src/__tests__/wu-done-git-ops-extraction.test.ts
  e2e: []
artifacts:
  - .lumenflow/stamps/WU-2205.done
dependencies: []
blocked_by:
  - WU-2204
risks: []
notes: (auto) Add implementation notes, rollout context, or a short summary of the plan/conversation.
requires_review: false
assigned_to: tom@hellm.ai
exposure: backend-only
escalation_triggers: []
requires_human_escalation: false
requires_cso_approval: false
requires_cto_approval: false
requires_design_approval: false
description: 'Context: wu:done currently executes overlapping sync checks across CLI, worktree orchestrator, and service validation layers with mixed semantics (exact parity vs not-behind). Problem: duplicated checks increase maintenance burden and can produce conflicting policy behavior. Solution: simplify wu:done sync checks to one canonical not-behind invariant for merge-capable paths while preserving safety guarantees and branch-pr exclusions.'
acceptance:
  - Remove or consolidate redundant wu:done sync checks so merge-capable paths enforce a single canonical not-behind invariant
  - Ensure branch-pr completion path does not run main-merge sync checks
  - Keep fail-closed behavior for wu:done remote sync validation failures where remote is required
  - Add/adjust tests for behind/ahead/diverged/network-failure wu:done scenarios to match canonical policy
