id: WU-1386
title: Extend lumenflow doctor with agent-friction checks
lane: 'Framework: CLI'
type: feature
status: in_progress
priority: P1
created: 2026-02-03
code_paths:
  - packages/@lumenflow/cli/src/doctor.ts
  - packages/@lumenflow/cli/src/init.ts
tests:
  manual:
    - Run lumenflow doctor on clean repo, expect existing + new checks pass
    - Modify .lumenflow.config.yaml without committing, run doctor, expect dirty warning
    - Run doctor --deep, verify wu:validate runs
    - Run lumenflow init, verify doctor runs at end (non-blocking)
  unit:
    - packages/@lumenflow/cli/src/__tests__/doctor.test.ts
  e2e: []
artifacts:
  - .lumenflow/stamps/WU-1386.done
dependencies: []
spec_refs:
  - ~/.claude/plans/delegated-imagining-fairy.md
risks: []
notes: |
  Origin: Haven 2.8.0 report identified agent drift from CLI workflow.
  Extends existing doctor.ts (WU-1177) - do not create new command.
  Key decisions:
  - Default doctor stays fast, --deep runs heavier wu:validate
  - Auto-run after init is non-blocking (exit 0 even with warnings)
  - Use wu:validate for WU checks, not custom _meta.created_by field
requires_review: false
assigned_to: tom@hellm.ai
exposure: backend-only
escalation_triggers: []
requires_human_escalation: false
requires_cso_approval: false
requires_cto_approval: false
requires_design_approval: false
description: "Context: Haven 2.8.0 agent manually edited config files and created WUs outside CLI
  workflow. Existing lumenflow doctor (WU-1177) doesn't detect these issues. Problem: Doctor checks
  infrastructure health but not workflow compliance. Agents can drift from CLI workflow without any
  diagnostic feedback. Solution: Extend existing doctor with managed-file dirty checks, WU
  validation, and worktree sanity checks. Add --deep mode for heavier checks."
acceptance:
  - 'Managed-file dirty check: warns if git status shows changes to .lumenflow.config.yaml,
    .lumenflow.lane-inference.yaml, docs/04-operations/tasks/**, AGENTS.md, CLAUDE.md'
  - 'WU validity check: runs wu:validate --all in warn-only mode (with --deep flag)'
  - 'Worktree sanity check: reuses wu:prune --check logic, warns on orphans'
  - 'Exit codes: 0=healthy, 1=warnings, 2=errors (missing critical safety)'
  - New --deep flag for heavier checks (default stays fast)
  - Auto-runs after lumenflow init (non-blocking, warnings only)
  - Never blocks init - prints warnings and returns success
claimed_mode: worktree
worktree_path: /home/tom/source/hellmai/os/worktrees/framework-cli-wu-1386
claimed_at: 2026-02-03T14:09:12.364Z
baseline_main_sha: 525d1039c87d2cf45cff6d8e6886682bb0b4ca06
session_id: 7d39bda2-167f-4e00-9a52-441b8d232adb
approved_by:
  - tom@hellm.ai
approved_at: 2026-02-03T14:09:12.370Z
