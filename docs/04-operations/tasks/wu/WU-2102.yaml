id: WU-2102
title: wu:prep checkpoint enables wu:done gate skip + scoped test fallback
lane: 'Framework: CLI WU Commands'
type: bug
status: in_progress
priority: P1
created: 2026-02-24
code_paths:
  - packages/@lumenflow/cli/src/wu-prep.ts
  - packages/@lumenflow/cli/src/wu-done.ts
  - packages/@lumenflow/cli/src/__tests__/wu-prep.test.ts
  - packages/@lumenflow/cli/src/__tests__/wu-done.test.ts
tests:
  manual:
    - Run wu:prep then wu:done on a real WU - verify wu:done prints checkpoint skip message and
      completes in under 60s
  unit:
    - packages/@lumenflow/core/src/__tests__/wu-checkpoint.test.ts
    - packages/@lumenflow/cli/src/__tests__/wu-prep.test.ts
    - packages/@lumenflow/cli/src/__tests__/wu-done.test.ts
  e2e: []
artifacts:
  - .lumenflow/stamps/WU-2102.done
dependencies: []
risks: []
notes: (auto) Add implementation notes, rollout context, or a short summary of the plan/conversation.
requires_review: false
claimed_mode: worktree
assigned_to: tom@hellm.ai
claimed_at: 2026-02-24T10:02:07.515Z
worktree_path: /home/tom/source/hellmai/os/worktrees/framework-cli-wu-commands-wu-2102
session_id: 82137215-e4a1-4db4-bebc-a4790ebe5a89
exposure: backend-only
escalation_triggers: []
requires_human_escalation: false
approved_by:
  - tom@hellm.ai
approved_at: 2026-02-24T10:02:07.520Z
requires_cso_approval: false
requires_cto_approval: false
requires_design_approval: false
description: 'wu:prep runs scoped gates (tests.unit paths, seconds) but does not write a gatesPassed
  checkpoint. wu:done therefore re-runs the full unscoped test suite (7+ minutes). The WU-1747
  canSkipGates infrastructure already exists in wu-checkpoint.ts but wu:prep never writes to it.
  Fix: (1) wu:prep writes a gatesPassed checkpoint after gates pass, (2) wu:done trusts that
  checkpoint via the existing canSkipGates check, (3) wu:done falls back to scopedTestPaths from
  tests.unit when no checkpoint and not --full-tests.'
acceptance:
  - wu:prep creates a gatesPassed checkpoint after gates succeed
  - wu:done skips gates entirely when a valid wu:prep checkpoint exists (canSkipGates returns true)
  - wu:done uses scopedTestPaths from WU tests.unit when no checkpoint and not --full-tests
  - Existing wu:done self-resumption (WU-1747) still works
