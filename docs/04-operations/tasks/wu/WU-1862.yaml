id: WU-1862
title: 'Evidence store durability: JSONL compaction and incremental replay'
lane: 'Framework: Core Lifecycle'
type: refactor
status: in_progress
priority: P2
created: 2026-02-18
code_paths:
  - packages/@lumenflow/kernel/src/evidence/evidence-store.ts
tests:
  manual:
    - Verify JSONL compaction triggers at threshold and preserves all events
    - Verify incremental replay returns correct events without full re-read
  unit:
    - packages/@lumenflow/kernel/src/__tests__/evidence-store.test.ts
  e2e: []
artifacts:
  - .lumenflow/stamps/WU-1862.done
dependencies: []
initiative: INIT-030
phase: 5
blocked_by:
  - WU-1860
risks: []
notes: 'Addresses review warnings W5 (unbounded JSONL growth) and W6 (O(n) replay). Both are in the
  same file and tightly coupled â€” compaction without incremental replay is pointless and vice versa.
  Target: log-structured merge approach similar to LSM trees but simplified for append-only event
  log.'
requires_review: false
assigned_to: tom@hellm.ai
exposure: backend-only
escalation_triggers: []
requires_human_escalation: false
requires_cso_approval: false
requires_cto_approval: false
requires_design_approval: false
description: 'W5+W6: The evidence store JSONL trace file grows unbounded with no compaction
  strategy, and replay() re-reads the entire file on every call (O(n)). At scale this degrades
  kernel performance and eventually exhausts disk. Implement log-structured compaction (rotate +
  compact cold segments) and incremental replay with a cursor/offset so hot-path reads are O(1)
  amortized.'
acceptance:
  - JSONL trace file is compacted when segment exceeds configurable size threshold
  - replay() uses incremental cursor, not full-file re-read
  - Compaction preserves all events (no data loss, append-only invariant holds)
  - Existing tests pass, new tests cover compaction + incremental replay
  - Benchmarks show O(1) amortized replay for hot-path reads
claimed_mode: worktree
worktree_path: /home/USER/source/hellmai/os/worktrees/framework-core-lifecycle-wu-1862
claimed_at: 2026-02-18T22:34:19.476Z
baseline_main_sha: 8ce4623ef521abf770b1437c9c8be75a78bbd835
session_id: 624ebc86-39cd-41e3-9426-f65b61704a11
approved_by:
  - tom@hellm.ai
approved_at: 2026-02-18T22:34:19.480Z
