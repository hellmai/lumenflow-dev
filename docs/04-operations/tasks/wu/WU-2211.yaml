id: WU-2211
title: wu:done --already-merged finalize-only mode
lane: 'Framework: CLI WU Commands'
type: feature
status: ready
priority: P2
created: 2026-02-26
code_paths:
  - packages/@lumenflow/cli/src/wu-done.ts
  - packages/@lumenflow/cli/src/wu-done-metadata.ts
  - packages/@lumenflow/cli/src/wu-done-merge-phase.ts
tests:
  manual:
    - Complete a WU whose code is already on main without a worktree
  unit:
    - packages/@lumenflow/cli/src/__tests__/wu-done.test.ts
  e2e: []
artifacts:
  - .lumenflow/stamps/WU-2211.done
dependencies: []
spec_refs:
  - memory/distributed-state-audit.md
risks: []
notes: (auto) Add implementation notes, rollout context, or a short summary of the plan/conversation.
requires_review: false
assigned_to: tom@hellm.ai
exposure: backend-only
sizing_estimate:
  estimated_files: 8
  estimated_tool_calls: 45
  strategy: single-session
escalation_triggers: []
requires_human_escalation: false
requires_cso_approval: false
requires_cto_approval: false
requires_design_approval: false
description: 'When code is already on main but WU metadata is incomplete (bootstrap failure, manual merge, aborted wu:done), wu:done requires a worktree that may not exist. Add --already-merged flag to skip merge phase and write stamp/events/backlog via micro-worktree. Safety check: verify code_paths exist on HEAD. Reuse existing metadata transaction from wu-done-metadata.ts.'
acceptance:
  - wu:done --already-merged --id WU-XXX skips merge phase entirely
  - Safety check verifies code_paths from YAML exist on HEAD of main
  - Stamp, completion event, backlog, and status are written via micro-worktree commit
  - Re-running is idempotent (stamp already_exists is not an error)
  - Fails with clear error if code_paths are NOT on main
