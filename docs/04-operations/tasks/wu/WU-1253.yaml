id: WU-1253
title: Implement test ratchet pattern with baseline comparison and agent guidance
lane: 'Framework: Core'
type: feature
status: ready
priority: P2
created: 2026-01-30
code_paths:
  - packages/@lumenflow/core/src/test-baseline.ts
  - packages/@lumenflow/core/src/wu-spawn.ts
  - .lumenflow/constraints.md
tests:
  manual: []
  unit:
    - packages/@lumenflow/core/src/__tests__/test-baseline.test.ts
  e2e: []
artifacts:
  - .lumenflow/stamps/WU-1253.done
dependencies: []
risks: []
notes: ''
requires_review: false
assigned_to: tom@hellm.ai
exposure: backend-only
escalation_triggers: []
requires_human_escalation: false
requires_cso_approval: false
requires_cto_approval: false
requires_design_approval: false
description: 'Context: WU-1210 changed implementation but didnt update corresponding test. Test failed on main for days. WU-1239 fixed by updating test expectations but this is a TDD violation. Problem: Gates dont distinguish pre-existing failures vs NEW failures you caused. Agents have TDD guidance but no explicit ratchet rule. Solution: (1) Test baseline file tracking known failures, (2) Gate modification to block NEW failures only, (3) Skip-gates debt tracking, (4) Agent guidance in wu:spawn and constraints.md.'
acceptance:
  - test-baseline.json file format defined
  - pnpm gates compares results against baseline
  - NEW test failures block gate, pre-existing allowed with warning
  - Baseline auto-updates when tests fixed (ratchet forward)
  - wu:spawn TDD directive includes Test Ratchet Rule
  - constraints.md has new constraint about test ratchet
  - Agent onboarding doc test-ratchet.md created
