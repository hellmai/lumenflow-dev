id: WU-1487
title: Harden worktree command UX for dist bootstrap and claim repair guidance
lane: 'Framework: CLI'
type: bug
status: done
priority: P2
created: 2026-02-06
code_paths:
  - package.json
  - packages/@lumenflow/cli/src/wu-done.ts
  - packages/@lumenflow/cli/src/wu-claim-repair-guidance.ts
  - packages/@lumenflow/cli/src/__tests__/wu-claim-repair-guidance.test.ts
  - packages/@lumenflow/cli/__tests__/spec-linter-worktree.test.ts
  - tools/cli-entry.mjs
  - tools/__tests__/cli-entry.test.ts
tests:
  manual:
    - In a freshly claimed worktree without built dist closure, run pnpm wu:prep --id WU-1487 and
      verify actionable bootstrap guidance (or successful auto-bootstrap retry).
    - In a freshly claimed worktree, run pnpm mem:checkpoint --wu WU-1487 and verify actionable
      bootstrap guidance (or successful auto-bootstrap retry).
    - Trigger claim metadata validation failure path in wu:done and confirm remediation text uses
      wu:repair --claim.
  unit:
    - packages/@lumenflow/cli/src/__tests__/wu-prep.test.ts
    - packages/@lumenflow/cli/src/__tests__/wu-done.test.ts
  e2e: []
artifacts:
  - .lumenflow/stamps/WU-1487.done
dependencies: []
spec_refs:
  - lumenflow://plans/WU-1487-plan.md
risks: []
notes: (auto) Add implementation notes, rollout context, or a short summary of the plan/conversation.
requires_review: false
claimed_mode: worktree
assigned_to: tom@hellm.ai
claimed_at: 2026-02-06T14:14:56.746Z
worktree_path: /home/tom/source/hellmai/os/worktrees/framework-cli-wu-1487
session_id: ae69ba7d-1604-4ea3-bde7-d1ef923689c2
exposure: backend-only
escalation_triggers: []
requires_human_escalation: false
approved_by:
  - tom@hellm.ai
approved_at: 2026-02-06T14:14:56.751Z
requires_cso_approval: false
requires_cto_approval: false
requires_design_approval: false
description: 'Context: We still hit workflow friction when worktree-scoped commands run without
  built dist artifacts and when wu:done emits outdated repair guidance. Problem: agents get
  MODULE_NOT_FOUND failures and stale remediation instructions, which slows completion and causes
  avoidable recovery loops. Solution: (1) replace stale wu:done repair guidance with the canonical
  wu:repair --claim command; (2) add bootstrap-aware fallback/diagnostics in worktree command paths
  (wu:prep, mem:checkpoint) so failures are actionable and optionally auto-bootstrap-safe; (3) sync
  internal docs/help text to the actual workflow.'
acceptance:
  - wu:done claim-metadata failure guidance points to pnpm wu:repair --claim --id WU-XXX (no
    deprecated wu:repair-claim references).
  - From a fresh worktree with missing dist closure, wu:prep and mem:checkpoint fail with explicit
    bootstrap guidance (pnpm bootstrap) instead of raw MODULE_NOT_FOUND noise.
  - If bootstrap fallback/auto-retry path is implemented, command succeeds after bootstrap in a
    single invocation; otherwise clear deterministic exit with exact next step.
  - Unit tests cover the updated guidance and missing-dist bootstrap diagnostics.
  - Internal docs/quick-ref are updated to match the final behavior.
locked: true
completed_at: 2026-02-06T14:23:05.913Z
