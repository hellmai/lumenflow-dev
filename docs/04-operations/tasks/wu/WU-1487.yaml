id: WU-1487
title: Harden worktree command UX for dist bootstrap and claim repair guidance
lane: 'Framework: CLI'
type: bug
status: ready
priority: P2
created: 2026-02-06
code_paths:
  - packages/@lumenflow/cli/src/wu-done.ts
  - packages/@lumenflow/cli/src/wu-prep.ts
  - packages/@lumenflow/cli/src/mem-checkpoint.ts
  - packages/@lumenflow/cli/src/__tests__/wu-prep.test.ts
  - packages/@lumenflow/cli/src/__tests__/wu-done.test.ts
  - docs/04-operations/_frameworks/lumenflow/agent/onboarding/quick-ref-commands.md
  - docs/04-operations/_frameworks/lumenflow/lumenflow-complete.md
tests:
  manual:
    - In a freshly claimed worktree without built dist closure, run pnpm wu:prep --id WU-1487 and verify actionable bootstrap guidance (or successful auto-bootstrap retry).
    - In a freshly claimed worktree, run pnpm mem:checkpoint --wu WU-1487 and verify actionable bootstrap guidance (or successful auto-bootstrap retry).
    - Trigger claim metadata validation failure path in wu:done and confirm remediation text uses wu:repair --claim.
  unit:
    - packages/@lumenflow/cli/src/__tests__/wu-prep.test.ts
    - packages/@lumenflow/cli/src/__tests__/wu-done.test.ts
  e2e: []
artifacts:
  - .lumenflow/stamps/WU-1487.done
dependencies: []
spec_refs:
  - lumenflow://plans/WU-1487-plan.md
risks: []
notes: (auto) Add implementation notes, rollout context, or a short summary of the plan/conversation.
requires_review: false
assigned_to: tom@hellm.ai
exposure: backend-only
escalation_triggers: []
requires_human_escalation: false
requires_cso_approval: false
requires_cto_approval: false
requires_design_approval: false
description: 'Context: We still hit workflow friction when worktree-scoped commands run without built dist artifacts and when wu:done emits outdated repair guidance. Problem: agents get MODULE_NOT_FOUND failures and stale remediation instructions, which slows completion and causes avoidable recovery loops. Solution: (1) replace stale wu:done repair guidance with the canonical wu:repair --claim command; (2) add bootstrap-aware fallback/diagnostics in worktree command paths (wu:prep, mem:checkpoint) so failures are actionable and optionally auto-bootstrap-safe; (3) sync internal docs/help text to the actual workflow.'
acceptance:
  - wu:done claim-metadata failure guidance points to pnpm wu:repair --claim --id WU-XXX (no deprecated wu:repair-claim references).
  - From a fresh worktree with missing dist closure, wu:prep and mem:checkpoint fail with explicit bootstrap guidance (pnpm bootstrap) instead of raw MODULE_NOT_FOUND noise.
  - If bootstrap fallback/auto-retry path is implemented, command succeeds after bootstrap in a single invocation; otherwise clear deterministic exit with exact next step.
  - Unit tests cover the updated guidance and missing-dist bootstrap diagnostics.
  - Internal docs/quick-ref are updated to match the final behavior.
