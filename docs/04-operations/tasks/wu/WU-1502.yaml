id: WU-1502
title: Add Bash PostToolUse dirty-main warning hook
lane: 'Framework: CLI Enforcement'
type: feature
status: in_progress
priority: P1
created: 2026-02-07
code_paths:
  - .claude/settings.json
  - .claude/hooks/warn-dirty-main.sh
  - packages/@lumenflow/cli/src/hooks/enforcement-generator.ts
  - packages/@lumenflow/cli/src/init.ts
  - packages/@lumenflow/cli/templates/
tests:
  manual:
    - Run a Bash command that writes files on main and verify warning includes modified paths
  unit:
    - packages/@lumenflow/cli/src/__tests__/hooks/enforcement.test.ts
  e2e: []
artifacts:
  - .lumenflow/stamps/WU-1502.done
dependencies:
  - WU-1501
initiative: INIT-017
phase: 2
spec_refs:
  - packages/@lumenflow/cli/src/hooks/enforcement-generator.ts
risks: []
notes: >-
  Implements Claude finding #2: catch script-generated writes that bypass Write/Edit hooks.


  Depends on WU-1501. Implement as shared detector plus vendor-specific wrappers, not Claude-only
  logic.
requires_review: false
assigned_to: tom@hellm.ai
exposure: backend-only
escalation_triggers: []
requires_human_escalation: false
requires_cso_approval: false
requires_cto_approval: false
requires_design_approval: false
description: 'Context: Write/Edit hooks do not see files modified indirectly by Bash-invoked
  scripts. Problem: generated file writes on main can bypass tool-level enforcement and remain
  orphaned. Solution: add a lightweight PostToolUse Bash hook that detects file modifications on
  main and emits a high-signal warning with changed paths.'
acceptance:
  - Add vendor-agnostic dirty-main detector in CLI/core; vendor hooks are generated thin wrappers
    that call shared logic
  - PostToolUse warning is emitted only on main checkout; no-op inside worktrees
  - Warning lists modified paths and guidance to create/claim a WU or discard changes
  - Clean working tree overhead remains under 50ms per Bash invocation
claimed_mode: worktree
worktree_path: /home/tom/source/hellmai/os/worktrees/framework-cli-enforcement-wu-1502
claimed_at: 2026-02-07T11:34:58.876Z
baseline_main_sha: d9572bd8a4ca4552b937b142b994f87808dc1567
session_id: 44412f2b-0702-4d11-b11b-72c5b807df25
approved_by:
  - tom@hellm.ai
approved_at: 2026-02-07T11:34:58.880Z
