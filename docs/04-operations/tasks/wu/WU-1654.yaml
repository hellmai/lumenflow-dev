id: WU-1654
title: 'Doctor: replace regex parsing with library-first structured calls'
lane: 'Framework: CLI WU Commands'
type: bug
status: ready
priority: P2
created: 2026-02-13
code_paths:
  - packages/@lumenflow/cli/src/doctor.ts
  - packages/@lumenflow/core/src/orphan-detector.ts
  - packages/@lumenflow/core/src/index.ts
  - packages/@lumenflow/core/src/lumenflow-config-schema.ts
  - packages/@lumenflow/cli/src/__tests__/doctor.test.ts
tests:
  manual:
    - Run lumenflow-doctor in a clean project and verify no false-positive orphan warning
  unit:
    - packages/@lumenflow/cli/src/__tests__/doctor.test.ts
  e2e: []
artifacts:
  - .lumenflow/stamps/WU-1654.done
dependencies: []
risks: []
notes: 'Reported by ExampleApp. Root cause: parseWorktreePruneOutput uses /orphan director/gi which matches wu:prune log lines, not just actual orphan entries. Math.max(summaryCount, detailCount > 0 ? 1 : 0) always picks the false positive. Fix: call orphan-detector library functions directly, eliminating all regex parsing of subprocess output.'
requires_review: false
assigned_to: tom@hellm.ai
exposure: backend-only
escalation_triggers: []
requires_human_escalation: false
requires_cso_approval: false
requires_cto_approval: false
requires_design_approval: false
description: lumenflow doctor parses wu:prune text output with regexes instead of calling @lumenflow/core/orphan-detector directly. This causes a false-positive orphan detection bug (regex matches log messages like 'Checking for orphan directories' and 'No orphan directories found'). Additionally, safe-git path and other paths are hardcoded instead of using getConfig()/getResolvedPaths() from @lumenflow/core.
acceptance:
  - Doctor calls detectOrphanWorktrees() and detectMissingTrackedWorktrees() from @lumenflow/core directly instead of shelling out to wu:prune and parsing text
  - orphan-detector is exported from @lumenflow/core public API (index.ts)
  - parseWorktreePruneOutput regex function is removed entirely
  - safe-git path is read from config (DirectoriesSchema.safeGitPath) with default scripts/safe-git
  - Doctor uses getConfig()/getResolvedPaths() for path resolution instead of hardcoded path.join() calls
  - Zero false-positive orphan detection when wu:prune reports 0 orphans
  - All existing doctor tests pass (updated to reflect new implementation)
