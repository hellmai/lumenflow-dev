id: WU-1654
title: 'Doctor: replace regex parsing with library-first structured calls'
lane: 'Framework: CLI Enforcement'
type: bug
status: in_progress
priority: P2
created: 2026-02-13
code_paths:
  - packages/@lumenflow/cli/src/doctor.ts
  - packages/@lumenflow/core/src/orphan-detector.ts
  - packages/@lumenflow/core/src/index.ts
  - packages/@lumenflow/core/src/lumenflow-config-schema.ts
  - packages/@lumenflow/core/src/lumenflow-config.ts
  - packages/@lumenflow/cli/src/__tests__/doctor.test.ts
tests:
  manual:
    - Run lumenflow-doctor in a clean project and verify no false-positive orphan warning
  unit:
    - packages/@lumenflow/cli/src/__tests__/doctor.test.ts
    - packages/@lumenflow/core/src/__tests__/orphan-detector.test.ts
    - packages/@lumenflow/core/src/__tests__/lumenflow-config-schema.test.ts
  e2e: []
artifacts:
  - .lumenflow/stamps/WU-1654.done
dependencies: []
risks: []
notes: 'Reported by . Root cause: parseWorktreePruneOutput uses /orphan director/gi which
  matches wu:prune log lines, not just actual orphan entries. Math.max(summaryCount, detailCount > 0
  ? 1 : 0) always picks the false positive. Fix: call orphan-detector library functions directly
  (detectOrphanWorktrees, detectMissingTrackedWorktrees), eliminating all regex parsing of
  subprocess output. Schema/config changes needed: add safeGitPath to DirectoriesSchema and
  getResolvedPaths(). Lane: CLI Enforcement (doctor is a diagnostic/enforcement tool, not a WU
  command).'
requires_review: false
assigned_to: tom@hellm.ai
exposure: backend-only
escalation_triggers: []
requires_human_escalation: false
requires_cso_approval: false
requires_cto_approval: false
requires_design_approval: false
description: lumenflow doctor parses wu:prune text output with regexes instead of calling
  @lumenflow/core/orphan-detector directly. This causes a false-positive orphan detection bug (regex
  matches log messages like 'Checking for orphan directories' and 'No orphan directories found').
  Additionally, safe-git path and other paths are hardcoded instead of using
  getConfig()/getResolvedPaths() from @lumenflow/core.
acceptance:
  - Doctor calls detectOrphanWorktrees() and detectMissingTrackedWorktrees() from @lumenflow/core
    directly instead of shelling out to pnpm wu:prune and parsing text
  - orphan-detector exports detectOrphanWorktrees and detectMissingTrackedWorktrees from
    @lumenflow/core public API (named exports in index.ts, not wildcard)
  - parseWorktreePruneOutput regex function and WorktreePruneParseResult interface removed entirely
    from doctor.ts
  - 'DirectoriesSchema in lumenflow-config-schema.ts extended with safeGitPath field (default:
    scripts/safe-git); getResolvedPaths() in lumenflow-config.ts returns it'
  - checkSafeGit() in doctor.ts reads safe-git path from getResolvedPaths().safeGitPath instead of
    hardcoded path.join(projectDir, scripts, safe-git)
  - Zero false-positive orphan detection when wu:prune reports 0 orphans
  - WorktreeSanityResult interface contract (orphans, stale, message) preserved or intentionally
    revised with corresponding test updates
  - Doctor tests updated for structured detector calls; full test suite passes
  - 'Core tests updated: orphan-detector.test.ts covers export surface;
    lumenflow-config-schema.test.ts covers safeGitPath field'
claimed_mode: worktree
worktree_path: /home/tom/source/hellmai/os/worktrees/framework-cli-enforcement-wu-1654
claimed_at: 2026-02-13T17:39:07.528Z
baseline_main_sha: b9fd27cc7d5d97850137dadc654193700aa3581f
session_id: a75643fc-ffaf-43bb-ad1a-5d4d6ef804e7
approved_by:
  - tom@hellm.ai
approved_at: 2026-02-13T17:39:07.532Z
