id: WU-1673
title: Prevent wu:done append-only conflict markers from entering wu-events
lane: 'Framework: Core Lifecycle'
type: bug
status: done
priority: P0
created: 2026-02-14
code_paths:
  - packages/@lumenflow/core/src/wu-done-worktree.ts
  - packages/@lumenflow/core/src/__tests__/no-process-chdir.test.ts
  - packages/@lumenflow/core/src/__tests__/wu-state-store.test.ts
  - packages/@lumenflow/cli/src/wu-repair.ts
  - packages/@lumenflow/cli/src/__tests__/wu-repair-state-mode.test.ts
tests:
  manual:
    - Simulate concurrent completions with rebase conflict on wu-events.jsonl; verify wu:done either
      auto-resolves cleanly or fails before commit with actionable error, and never pushes conflict
      markers
  unit:
    - packages/@lumenflow/core/src/__tests__/no-process-chdir.test.ts
  e2e: []
artifacts:
  - .lumenflow/stamps/WU-1673.done
dependencies: []
risks: []
notes: Incident follow-up for WU-1672/WU-1671 rebase conflict loop. Focus on preventing malformed
  state propagation to main and lane branches.
requires_review: false
claimed_mode: worktree
assigned_to: tom@hellm.ai
claimed_at: 2026-02-14T09:04:47.577Z
worktree_path: /home/tom/source/hellmai/os/worktrees/framework-core-lifecycle-wu-1673
session_id: 9001309a-357f-43ba-a952-66f7b6684b02
exposure: backend-only
escalation_triggers: []
requires_human_escalation: false
approved_by:
  - tom@hellm.ai
approved_at: 2026-02-14T09:04:47.582Z
requires_cso_approval: false
requires_cto_approval: false
requires_design_approval: false
description: 'Context: during wu:done auto-rebase conflict handling, append-only resolution for
  .lumenflow/state/wu-events.jsonl can still result in conflict markers (<<<<<<<, =======, >>>>>>>)
  being committed and pushed, causing malformed JSON and cascading failures in wu:done and wu:repair
  --claim. Problem observed on 2026-02-14 with WU-1672 and WU-1671. Solution: harden append-only
  conflict resolution and add pre-commit guardrails so wu:done cannot commit/push conflict-marker
  content in state files.'
acceptance:
  - auto-rebase append-only resolution for wu-events.jsonl never writes merge markers
  - wu:done aborts before commit if conflict markers exist in any transaction output file
  - regression tests cover append-only rebase conflict path and marker-detection guard
  - wu:repair --repair-state successfully restores malformed wu-events.jsonl from merge-marker state
locked: true
completed_at: 2026-02-14T09:43:04.731Z
completed: 2026-02-14
