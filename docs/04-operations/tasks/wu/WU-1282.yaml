id: WU-1282
title: 'Bug: Task-spawned sub-agents bypass PreToolUse hooks'
lane: 'Framework: Core'
type: bug
status: in_progress
priority: P1
created: 2026-01-31
code_paths:
  - packages/@lumenflow/core/src/wu-spawn.ts
  - packages/@lumenflow/core/src/__tests__/wu-spawn.test.ts
  - docs/04-operations/_frameworks/lumenflow/agent/onboarding/agent-safety-card.md
tests:
  manual:
    - Spawn sub-agent via Task tool and verify constraint #9 WORKTREE DISCIPLINE is included
    - Verify sub-agent spawn prompt includes WU-1282 reference
  unit:
    - packages/@lumenflow/core/src/__tests__/wu-spawn.test.ts
  e2e: []
artifacts:
  - .lumenflow/stamps/WU-1282.done
dependencies: []
initiative: INIT-012
phase: 1
risks:
  - Claude Code platform limitation - cannot be fully fixed without Anthropic update
notes: |
  ## Root Cause Analysis

  Claude Code's Task tool spawns sub-agents in a completely new session context.
  The PreToolUse hooks defined in `.claude/settings.json` are only loaded at the
  start of a top-level Claude session. When a Task tool spawns a sub-agent, that
  sub-agent runs fresh without hook inheritance.

  This is a Claude Code platform limitation, not a LumenFlow bug.

  ## Fix Implemented

  Added constraint #9 (WORKTREE DISCIPLINE) to spawn prompts in wu-spawn.ts:
  - Instructs sub-agents to manually verify worktree location before Write/Edit
  - Documents the hook bypass issue explicitly
  - Provides verification command (pwd must show worktrees/)

  ## Files Modified

  1. `packages/@lumenflow/core/src/wu-spawn.ts` - Added constraint #9 to generateConstraints()
  2. `docs/04-operations/_frameworks/lumenflow/agent/onboarding/agent-safety-card.md` -
     Added Task Tool Hook Limitation section

  ## Verification

  Run `pnpm wu:spawn --id WU-XXX` and verify output contains:
  - "9. WORKTREE DISCIPLINE (WU-1282)"
  - "hooks do not propagate to sub-agents"
requires_review: false
assigned_to: tom@hellm.ai
exposure: backend-only
escalation_triggers: []
requires_human_escalation: false
requires_cso_approval: false
requires_cto_approval: false
requires_design_approval: false
description: Task-spawned sub-agents via Task tool do not inherit PreToolUse hooks from parent
  session. The validate-worktree-path.sh hook did not run for a spawned agent, allowing it to write
  to main repo (cli.mdx) while worktrees existed. This is a security gap - agents can bypass safety
  hooks by spawning sub-agents. Discovered during INIT-008 Wave 0 execution.
acceptance:
  - Investigate why hooks don't propagate to Task-spawned agents
  - Document root cause and propose fix
  - Implement fix to ensure hooks run in sub-agents
claimed_mode: worktree
worktree_path: /home/tom/source/hellmai/os/worktrees/framework-core-wu-1282
claimed_at: 2026-01-31T17:56:51.487Z
baseline_main_sha: 4b11b2ac854168f2b61e6554479d3c16c93aeed6
session_id: 5d3e8f37-9e29-4b97-861f-12e941e42ce9
approved_by:
  - tom@hellm.ai
approved_at: 2026-01-31T17:56:51.492Z
