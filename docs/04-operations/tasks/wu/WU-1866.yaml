id: WU-1866
title: 'INIT-030 Review Fix D: flip executeViaPack fallback from denylist to allowlist'
lane: 'Framework: MCP'
type: bug
status: ready
priority: P0
created: 2026-02-18
code_paths:
  - packages/@lumenflow/mcp/src/tools-shared.ts
tests:
  manual:
    - Verify unknown future error code returns directly (no CLI fallback)
  unit:
    - packages/@lumenflow/mcp/src/__tests__/tools-shared.test.ts
  e2e: []
artifacts:
  - .lumenflow/stamps/WU-1866.done
dependencies: []
initiative: INIT-030
phase: 5
blocked_by:
  - WU-1859
risks: []
notes: Identified by cross-review (Claude + Codex). WU-1859 fixed the specific codes but used the wrong pattern. This is the sanitize-bad-input anti-pattern â€” denylist security inevitably misses new entries.
requires_review: false
assigned_to: tom@hellm.ai
exposure: backend-only
escalation_triggers: []
requires_human_escalation: false
requires_cso_approval: false
requires_cto_approval: false
requires_design_approval: false
description: 'executeViaPack uses NON_FALLBACK_ERROR_CODES denylist to prevent CLI fallback on security denials. This is fail-open: any new kernel denial error code silently falls through to CLI until someone remembers to add it. The correct pattern is an allowlist of codes that MAY fall back (TOOL_NOT_FOUND for migration compat), returning all other failures directly. Default-deny for fallback, not default-allow.'
acceptance:
  - FALLBACK_ALLOWED_ERROR_CODES allowlist replaces NON_FALLBACK_ERROR_CODES denylist
  - Only TOOL_NOT_FOUND triggers CLI fallback from runtime failures
  - All other error codes (including unknown future codes) return directly without CLI fallback
  - Thrown exceptions from runtime (catch block) also return directly instead of falling through to CLI
  - Existing tests updated to verify allowlist behavior
