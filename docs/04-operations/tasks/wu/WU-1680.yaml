id: WU-1680
title: 'Validator Layer V2: unify phase-aware rules and adapters'
lane: 'Framework: CLI WU Commands'
type: refactor
status: in_progress
priority: P1
created: 2026-02-15
code_paths:
  - packages/@lumenflow/cli/__tests__/wu-create-validation-aggregate.test.ts
  - packages/@lumenflow/cli/src/__tests__/wu-create-required-fields.test.ts
  - packages/@lumenflow/cli/src/__tests__/wu-create-strict.test.ts
  - packages/@lumenflow/cli/src/__tests__/wu-create.test.ts
  - packages/@lumenflow/cli/src/__tests__/wu-validate.test.ts
  - packages/@lumenflow/cli/src/wu-code-path-coverage.ts
  - packages/@lumenflow/cli/src/wu-create-content.ts
  - packages/@lumenflow/cli/src/wu-create-validation.ts
  - packages/@lumenflow/cli/src/wu-create.ts
  - packages/@lumenflow/cli/src/wu-done.ts
  - packages/@lumenflow/cli/src/wu-edit-operations.ts
  - packages/@lumenflow/cli/src/wu-edit.ts
  - packages/@lumenflow/cli/src/wu-prep.ts
  - packages/@lumenflow/cli/src/wu-validate.ts
  - packages/@lumenflow/core/package.json
  - packages/@lumenflow/core/src/__tests__/wu-lint-parity.test.ts
  - packages/@lumenflow/core/src/__tests__/wu-preflight-validators-reality.test.ts
  - packages/@lumenflow/core/src/__tests__/wu-rules-core.test.ts
  - packages/@lumenflow/core/src/__tests__/wu-rules-engine.test.ts
  - packages/@lumenflow/core/src/index.ts
  - packages/@lumenflow/core/src/wu-done-preflight.ts
  - packages/@lumenflow/core/src/wu-lint.ts
  - packages/@lumenflow/core/src/wu-preflight-validators.ts
  - packages/@lumenflow/core/src/wu-rules-core.ts
  - packages/@lumenflow/core/src/wu-rules-engine.ts
  - packages/@lumenflow/core/src/wu-rules-resolvers.ts
  - packages/@lumenflow/cli/__tests__/docs-generate.test.ts
  - packages/@lumenflow/cli/__tests__/orchestrate-initiative.test.ts
  - packages/@lumenflow/cli/e2e/claude-enforcement.test.ts
tests:
  manual:
    - Run wu:create/wu:edit/wu:validate/wu:prep/wu:done scenarios and confirm phase-specific
      validation behavior.
  unit:
    - packages/@lumenflow/core/src/__tests__/wu-lint-parity.test.ts
    - packages/@lumenflow/core/src/__tests__/wu-preflight-validators.test.ts
    - packages/@lumenflow/core/src/__tests__/wu-done-preflight.test.ts
    - packages/@lumenflow/cli/src/__tests__/wu-create-required-fields.test.ts
    - packages/@lumenflow/cli/src/__tests__/wu-prep.test.ts
    - packages/@lumenflow/cli/src/__tests__/wu-validate.test.ts
  e2e: []
artifacts:
  - .lumenflow/stamps/WU-1680.done
dependencies: []
risks: []
notes: 'Sizing per wu-sizing-guide: Medium. Estimated 10-18 files, 50-100 tool calls, context target
  <50%. Use checkpoint if triggers are hit.'
requires_review: false
claimed_mode: worktree
assigned_to: tom@hellm.ai
claimed_at: 2026-02-15T09:45:06.046Z
worktree_path: /home/tom/source/hellmai/os/worktrees/framework-cli-wu-commands-wu-1680
session_id: 5fa86655-0561-4e7d-8628-dace82f7fa35
exposure: backend-only
escalation_triggers: []
requires_human_escalation: false
approved_by:
  - tom@hellm.ai
approved_at: 2026-02-15T09:45:06.052Z
requires_cso_approval: false
requires_cto_approval: false
requires_design_approval: false
description: 'Context: validators for lint, preflight, create/edit, prep, and done evolved
  independently. Problem: contradictory enforcement creates catch-22 failures (parity heuristic vs
  code_paths coverage, glob mismatch in existence checks, tests.unit prose treated as paths).
  Solution: implement a shared phase-aware rules engine in core and route existing validators
  through adapters so create/edit/validate use intent/structural checks while prep/done enforce
  reality checks.'
acceptance:
  - Shared rules engine provides intent, structural, and reality profiles with reusable context and
    issue model.
  - Registration parity checks only when CLI package bin changes; metadata-only package.json edits
    do not block completion.
  - code_paths glob behavior is consistent across existence and coverage checks, with
    any-match-per-glob coverage semantics.
  - Create/edit require minimum test intent without forcing fake tests.unit paths; prep/done enforce
    automated test path classification and existence.
  - Adapters preserve existing command interfaces and test contracts while removing contradictory
    duplicated logic.
