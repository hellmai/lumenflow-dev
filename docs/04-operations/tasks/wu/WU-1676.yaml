id: WU-1676
title: Scope wu:prep test gate to WU tests.unit entries
lane: 'Framework: CLI WU Commands'
type: refactor
status: in_progress
priority: P1
created: 2026-02-14
code_paths:
  - packages/@lumenflow/cli/src/wu-prep.ts
  - packages/@lumenflow/cli/src/gates.ts
  - packages/@lumenflow/cli/src/gates-runners.ts
  - packages/@lumenflow/cli/src/wu-create-validation.ts
  - packages/@lumenflow/cli/src/wu-validate.ts
  - packages/@lumenflow/core/src/wu-lint.ts
tests:
  manual:
    - Run wu:prep on a WU with tests.unit entries and verify only those files are tested
  unit:
    - packages/@lumenflow/cli/src/__tests__/wu-prep.test.ts
    - packages/@lumenflow/cli/src/__tests__/wu-create-required-fields.test.ts
    - packages/@lumenflow/core/src/__tests__/wu-lint-parity.test.ts
  e2e: []
artifacts:
  - .lumenflow/stamps/WU-1676.done
dependencies: []
risks: []
notes: 'Incident: WU-1674 wu:prep took 8+ minutes and OOMed/timed out on unrelated tests while the 9
  WU-specific test files passed in 6 seconds. Root cause: tests.unit was optional so wu:prep had no
  scoping information.'
requires_review: false
assigned_to: tom@hellm.ai
exposure: backend-only
escalation_triggers: []
requires_human_escalation: false
requires_cso_approval: false
requires_cto_approval: false
requires_design_approval: false
description: 'Context: wu:prep default incremental gate runs vitest run --changed origin/main, which
  picks up all changed files in affected packages (123 files, 2096 tests for @lumenflow/cli alone).
  Problem: WU specs can omit tests.unit, causing wu:prep to run broad incremental tests where
  unrelated failures (OOM, timeout) block WUs whose actual tests pass in seconds. Solution: (1) spec
  linter requires tests.unit for non-documentation WUs with code_paths, (2) wu:prep replaces the
  INCREMENTAL_TEST gate with scoped vitest run on tests.unit paths from the WU YAML.'
acceptance:
  - Spec linter fails when tests.unit is empty for non-documentation WUs that have code_paths
  - wu:create enforces at least one --test-paths-unit entry for non-documentation WUs with code_paths
  - wu:prep replaces the INCREMENTAL_TEST gate with scoped vitest run on tests.unit paths;
    SAFETY_CRITICAL_TEST and other gates remain unchanged
  - Full incremental test suite remains available via wu:prep --full-tests flag
  - Targeted test run completes in under 30s for typical WUs
claimed_mode: worktree
worktree_path: /home/tom/source/hellmai/os/worktrees/framework-cli-wu-commands-wu-1676
claimed_at: 2026-02-14T12:44:13.056Z
baseline_main_sha: a326b9c6b4ba37b2d483b15d1bf0b2d858fcbd91
session_id: d212e063-2846-4b67-8a31-a8abc431a0ec
approved_by:
  - tom@hellm.ai
approved_at: 2026-02-14T12:44:13.061Z
