id: WU-1492
title: Add wu:done branch-pr completion path
lane: 'Framework: Core'
type: feature
status: ready
priority: P1
created: 2026-02-06
code_paths:
  - packages/@lumenflow/core/src/wu-done-branch-only.ts
  - packages/@lumenflow/core/src/wu-done-pr.ts
  - packages/@lumenflow/core/src/wu-done-cleanup.ts
  - packages/@lumenflow/cli/src/wu-done.ts
  - packages/@lumenflow/cli/src/wu-edit.ts
  - packages/@lumenflow/core/src/__tests__/wu-done-branch-only.test.ts
  - packages/@lumenflow/core/src/__tests__/wu-done-cleanup.test.ts
  - packages/@lumenflow/cli/src/__tests__/wu-done.test.ts
  - packages/@lumenflow/cli/src/__tests__/wu-edit.test.ts
tests:
  manual:
    - Run wu:done in branch-pr mode and verify PR creation + no main merge; verify wu:cleanup post-merge behavior.
  unit:
    - packages/@lumenflow/core/src/__tests__/wu-done-branch-only.test.ts
    - packages/@lumenflow/core/src/__tests__/wu-done-cleanup.test.ts
    - packages/@lumenflow/cli/src/__tests__/wu-done.test.ts
    - packages/@lumenflow/cli/src/__tests__/wu-edit.test.ts
  e2e: []
artifacts:
  - .lumenflow/stamps/WU-1492.done
dependencies: []
initiative: INIT-016
phase: 3
blocked_by:
  - WU-1490
spec_refs:
  - lumenflow://plans/memoized-baking-sutton.md
risks: []
notes: WU-C from branch-pr cloud initiative plan; includes branch-pr safety check for wu:edit pathing.
requires_review: false
assigned_to: tom@hellm.ai
exposure: backend-only
escalation_triggers: []
requires_human_escalation: false
requires_cso_approval: false
requires_cto_approval: false
requires_design_approval: false
description: 'Context: branch-pr mode must complete WUs without switching to main merge flow. Problem: branch-only completion currently hard-switches to main and merge semantics; PR-mode cleanup checks only worktree-pr. Solution: add a branch-pr done path that commits metadata on lane branch, pushes, and creates PR while preserving cleanup behavior and backward compatibility.'
acceptance:
  - For claimed_mode=branch-pr, wu:done stays on lane branch, commits metadata, pushes, and creates PR.
  - branch-pr flow never checks out or merges to main during completion.
  - Cleanup logic treats branch-pr as PR-mode and preserves wu:cleanup post-merge behavior.
  - Existing worktree/worktree-pr/branch-only flows remain unchanged.
  - Claimed-mode-sensitive CLI behavior (including wu:edit handling) does not misclassify branch-pr as worktree-only.
