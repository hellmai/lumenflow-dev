id: WU-2158
title: Add co-change gate to Software Delivery Pack
lane: 'Framework: Core Lifecycle'
type: feature
status: done
priority: P2
created: 2026-02-25
code_paths:
  - packages/@lumenflow/cli/src/gates-runners.ts
  - packages/@lumenflow/cli/src/gate-defaults.ts
  - packages/@lumenflow/core/src/schemas/gates-section-config.ts
  - packages/@lumenflow/core/src/wu-cli-constants.ts
tests:
  manual:
    - Verify gate warns when schema file changes without migration file
    - Verify gate passes when both schema and migration files change
    - Verify gate skips when no trigger pattern files are changed
  unit:
    - packages/@lumenflow/cli/tests/gates-co-change.test.ts
    - packages/@lumenflow/cli/src/__tests__/gates-co-change.test.ts
  e2e: []
artifacts:
  - .lumenflow/stamps/WU-2158.done
dependencies: []
plan: lumenflow://plans/WU-2158-plan.md
spec_refs:
  - lumenflow://plans/WU-2158-co-change-gate.md
  - lumenflow://plans/WU-2158-plan.md
risks: []
notes: "Design review decisions: (1) Runner in gates-runners.ts not pack dir — pragmatic, avoids
  half-extracting runners into packs which creates worse inconsistency. (2) Config in
  GatesConfigSchema not per-pack config block — per-pack config namespace doesn't exist yet, and
  kernel schema already has software-specific fields like enableSafetyCriticalTests. (3) Use
  micromatch for glob matching — already transitive dep via Vitest, handles
  double-star/brace/negation correctly. (4) Three-state severity (warn/error/off) mirrors
  lane_health pattern."
requires_review: false
assigned_to: tom@hellm.ai
exposure: backend-only
escalation_triggers: []
requires_human_escalation: false
requires_cso_approval: false
requires_cto_approval: false
requires_design_approval: false
description: When schema files change in a WU but no corresponding migration files are included,
  deployed code can reference tables/columns that don't exist yet. This has happened on PatientPath
  and LumenFlow Cloud. Add a configurable co-change gate to the Software Delivery Pack that detects
  when files matching trigger patterns change without corresponding files matching require patterns
  also changing.
acceptance:
  - 'co-change gate runner in gates-runners.ts (pragmatic: alongside existing runners, not in pack
    directory)'
  - co_change config field added to GatesConfigSchema as z.array of {name, trigger_patterns,
    require_patterns, severity} with severity enum warn|error|off
  - Gate uses getChangedFilesForIncremental() to detect changed files and micromatch for glob
    matching against relative paths
  - 'severity: warn logs warning but does not block; severity: error blocks wu:prep; severity: off
    skips the rule'
  - Multiple co-change rules can be defined as array entries (schema/migration is just one example
    config)
  - Gate registered in registerCodeGates() via CodeGateOptions, positioned after lint but before test
  - 'Unit tests cover: trigger match with no require match (fail), trigger match with require match
    (pass), no trigger match (skip), severity off (skip)'
  - Implementation is generic mechanism only — no domain-specific logic for proto/OpenAPI/changelog
    cases
claimed_mode: worktree
worktree_path: worktrees/framework-core-lifecycle-wu-2158
claimed_at: 2026-03-01T23:12:20.032Z
baseline_main_sha: b821c619cdb741cc9b96726ae2d43adee4b2a093
session_id: 820be9ca-8766-4b31-b623-daf0d6d3bad3
approved_by:
  - tom@hellm.ai
approved_at: 2026-03-01T23:12:20.037Z
locked: true
completed_at: 2026-03-01T23:31:23.854Z
completed: 2026-03-02
