id: WU-1070
title: Add audit logging and guarding for LUMENFLOW_FORCE bypass
lane: 'Operations: Infrastructure'
type: feature
status: done
priority: P1
created: 2026-01-23
code_paths:
  - .husky/hooks/pre-commit.mjs
  - .husky/hooks/pre-push.mjs
  - .husky/hooks/commit-msg.mjs
  - .husky/hooks/prepare-commit-msg.mjs
  - packages/@lumenflow/core/src/force-bypass-audit.ts
  - .lumenflow/constraints.md
tests:
  manual:
    - Set LUMENFLOW_FORCE=1 and commit; verify audit log entry created
    - Set LUMENFLOW_FORCE=1 without LUMENFLOW_FORCE_REASON; verify warning logged
    - Verify .lumenflow/force-bypasses.log contains timestamp, user, reason, hook name
  unit:
    - packages/@lumenflow/core/src/__tests__/force-bypass-audit.test.ts
  e2e: []
artifacts:
  - .lumenflow/stamps/WU-1070.done
dependencies: []
spec_refs:
  - internal
risks:
  - Audit logging must not block the bypass (fail-open for audit, fail-closed would defeat purpose)
notes: 'Security hardening: agents should not use LUMENFLOW_FORCE without explicit user approval'
requires_review: false
assigned_to: tom@hellm.ai
exposure: backend-only
escalation_triggers: []
requires_human_escalation: false
requires_cso_approval: false
requires_cto_approval: false
requires_design_approval: false
description: |
  Context: LUMENFLOW_FORCE=1 allows bypassing all git hooks (pre-commit, pre-push, commit-msg).
  Currently there is no audit trail and no enforcement - any process can set the env var.

  Problem: Agents can use LUMENFLOW_FORCE to bypass workflow rules without accountability.
  This undermines the entire LumenFlow enforcement model.

  Solution: Add audit logging and soft guarding:
  1. All hooks log bypass usage to .lumenflow/force-bypasses.log (git-tracked for accountability)
  2. Require LUMENFLOW_FORCE_REASON env var (warn if missing, don't block)
  3. Add constraint to .lumenflow/constraints.md that agents must not use without user approval
  4. Log includes: timestamp, hook name, git user, reason, branch, working directory
acceptance:
  - All 4 husky hooks log to .lumenflow/force-bypasses.log when LUMENFLOW_FORCE=1
  - 'Log format: ISO timestamp | hook name | git user.name | branch | reason | cwd'
  - LUMENFLOW_FORCE_REASON env var documented and logged (warn to stderr if missing)
  - Shared audit function in packages/@lumenflow/core/src/force-bypass-audit.ts
  - .lumenflow/force-bypasses.log is git-tracked (NOT in .gitignore)
  - .lumenflow/constraints.md updated with rule against agent LUMENFLOW_FORCE usage
  - Agent constraint includes escalation path (ask user, get explicit approval)
  - Audit logging is fail-open (if logging fails, bypass still works)
  - Unit tests verify log format and content
claimed_mode: worktree
worktree_path: /home/USER/source/hellmai/os/worktrees/operations-infrastructure-wu-1070
claimed_at: 2026-01-23T09:54:08.506Z
baseline_main_sha: 5228f0ef6d2f808dd9b02e686caee5893d6a679a
session_id: 685f767e-a25e-4b8e-9511-bf96be168b3b
approved_by:
  - tom@hellm.ai
approved_at: 2026-01-23T09:54:08.512Z
locked: true
completed_at: 2026-01-23T10:01:24.358Z
