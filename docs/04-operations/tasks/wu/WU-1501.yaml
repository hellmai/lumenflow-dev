id: WU-1501
title: Close fail-open gap in validate-worktree-path hook
lane: 'Framework: CLI'
type: bug
status: ready
priority: P2
created: 2026-02-07
code_paths:
  - .claude/hooks/validate-worktree-path.sh
  - .claude/hooks/validate-worktree-path.test.sh
  - packages/@lumenflow/cli/src/hooks/enforcement-generator.ts
  - packages/@lumenflow/cli/src/init.ts
tests:
  manual:
    - Run hook script with simulated no-worktree state and verify Write/Edit blocked on main
  unit:
    - packages/@lumenflow/cli/src/__tests__/hooks/enforcement.test.ts
  e2e: []
artifacts:
  - .lumenflow/stamps/WU-1501.done
dependencies: []
risks: []
notes: 'Implements Claude finding #1: fail-open window after worktree deletion.'
requires_review: false
assigned_to: tom@hellm.ai
exposure: backend-only
escalation_triggers: []
requires_human_escalation: false
requires_cso_approval: false
requires_cto_approval: false
requires_design_approval: false
description: 'Context: validate-worktree-path currently allows Write/Edit when no worktrees exist, leaving main effectively unguarded after wu:done cleanup. Problem: this fail-open behavior permits untracked main writes outside active WUs. Solution: fail closed on main unless explicit safe exceptions are matched and/or an active claimed WU context permits the write.'
acceptance:
  - Hook blocks Write/Edit on main by default when no active claim context exists
  - Safe exception list is explicit and test-covered (e.g. wu:create/wu:claim scaffolding paths)
  - Regression tests cover no-worktree and post-wu-done scenarios
