id: WU-1062
title: External plan storage and no-main-write mode for wu:create
lane: 'Framework: Core'
type: feature
status: in_progress
priority: P1
created: 2026-01-22
code_paths:
  - packages/@lumenflow/core/src/lumenflow-home.ts
  - packages/@lumenflow/cli/src/wu-create.ts
  - packages/@lumenflow/core/src/wu-create-validators.ts
  - packages/@lumenflow/core/src/micro-worktree.ts
  - packages/@lumenflow/core/src/wu-schema.ts
  - packages/@lumenflow/core/src/wu-spawn.ts
  - packages/@lumenflow/cli/src/wu-spawn.ts
  - packages/@lumenflow/core/src/arg-parser.ts
  - packages/@lumenflow/core/src/index.ts
  - packages/@lumenflow/cli/src/wu-claim.ts
  - packages/@lumenflow/core/src/wu-claim-helpers.ts
  - LUMENFLOW.md
  - docs/04-operations/_frameworks/lumenflow/playbook.md
  - docs/04-operations/_frameworks/lumenflow/agent/onboarding/quick-ref-commands.md
tests:
  manual:
    - wu:create --id WU-TEST --plan creates spec branch + external plan
    - wu:create --id WU-TEST --direct writes to main (legacy behavior)
    - wu:claim --id WU-TEST merges spec branch before creating worktree
  unit:
    - packages/@lumenflow/core/src/__tests__/lumenflow-home.test.ts
    - packages/@lumenflow/core/src/__tests__/spec-branch.test.ts
    - packages/@lumenflow/core/src/__tests__/wu-claim-spec-branch.test.ts
    - packages/@lumenflow/core/src/__tests__/wu-create-validators.test.ts
    - packages/@lumenflow/core/src/__tests__/arg-parser-wu-create.test.ts
  e2e: []
artifacts:
  - .beacon/stamps/WU-1062.done
dependencies: []
risks:
  - External plans not version-controlled by default
  - Breaking change if wu:claim assumes WU always on main
notes: 'Bootstrap WU: external plan stored in lumenflow://plans/; spec_refs intentionally external
  until validator updated in WU-1062.'
requires_review: false
claimed_mode: worktree
assigned_to: tom@hellm.ai
claimed_at: 2026-01-22T20:32:03.819Z
worktree_path: /home/tom/source/hellmai/os/worktrees/framework-core-wu-1062
session_id: d306dc42-ef0b-427e-b08a-e7218a371d47
exposure: backend-only
escalation_triggers: []
requires_human_escalation: false
approved_by:
  - tom@hellm.ai
approved_at: 2026-01-22T20:32:03.826Z
requires_cso_approval: false
requires_cto_approval: false
requires_design_approval: false
description: >
  Define $LUMENFLOW_HOME for external storage (~/.lumenflow/). Store plans in $LUMENFLOW_HOME/plans/
  instead of repo. Make wu:create operate in spec branch by default (spec/wu-XXXX), never writing to
  main directly. Update wu:claim to merge spec branch to main before creating worktree. Add --direct
  flag for legacy main-write behavior.
acceptance:
  - $LUMENFLOW_HOME env var defined with default ~/.lumenflow/
  - getLumenflowHome() and getPlansDir() helpers exported from @lumenflow/core
  - spec_refs validation accepts external paths (~/.lumenflow/..., $LUMENFLOW_HOME/...)
  - spec_refs warning in wu-spawn updated to handle external paths
  - wu:create defaults to spec branch mode (creates spec/wu-XXXX branch, no main writes)
  - wu:create --plan creates plan template in $LUMENFLOW_HOME/plans/
  - wu:create --direct preserves current main-write behavior (legacy/emergency)
  - arg-parser.ts defines WU_CREATE_OPTIONS with --plan and --direct flags
  - wu:claim detects if WU exists only on spec branch (not main)
  - wu:claim merges spec/wu-XXXX to main before creating worktree
  - wu:claim fails gracefully if spec branch doesn't exist and WU not on main
  - Existing in-repo plans remain valid (no breaking change)
  - WUs already on main work without spec branch merge
  - LUMENFLOW.md updated with new wu:create flow
  - playbook.md updated with spec branch pattern
  - quick-ref-commands.md updated with new flags
