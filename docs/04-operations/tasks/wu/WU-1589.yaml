id: WU-1589
title: 'Cloud Foundation: claimed_branch schema, resolver, hook'
lane: 'Framework: Core Lifecycle'
type: feature
status: in_progress
priority: P0
created: 2026-02-12
code_paths:
  - packages/@lumenflow/core/src/wu-schema.ts
  - packages/@lumenflow/core/src/wu-done-paths.ts
  - .husky/hooks/pre-commit.mjs
  - .lumenflow.config.yaml
  - packages/@lumenflow/cli/src/wu-claim.ts
  - packages/@lumenflow/cli/src/wu-release.ts
  - packages/@lumenflow/cli/src/wu-recover.ts
tests:
  manual:
    - Run branch-pr claim/release/recover lifecycle and verify claimed_branch + claimed_mode reset
      behavior.
  unit:
    - packages/@lumenflow/core/src/__tests__/wu-done-paths.test.ts
    - packages/@lumenflow/core/src/__tests__/cloud-detect.test.ts
    - packages/@lumenflow/cli/src/__tests__/wu-claim.test.ts
  e2e: []
artifacts:
  - .lumenflow/stamps/WU-1589.done
dependencies: []
initiative: INIT-023
phase: 1
spec_refs:
  - lumenflow://plans/INIT-023-plan.md
risks: []
notes: Pattern B decomposition WU-A foundation slice. Establish shared metadata + resolver
  invariants used by downstream cloud lifecycle commands.
requires_review: false
assigned_to: tom@hellm.ai
exposure: backend-only
escalation_triggers: []
requires_human_escalation: false
requires_cso_approval: false
requires_cto_approval: false
requires_design_approval: false
description: 'Context: Branch-pr cloud agents need first-class lifecycle support but core metadata
  and branch resolution still assume lane-derived local workflows. Problem: branch-pr flows cannot
  reliably resolve actual branches or pass commit hooks, and reset paths can leave stale claim
  metadata. Solution: add claimed_branch as canonical branch metadata, prioritize it in shared
  branch resolution, allow branch-pr in pre-commit gating, and harden rollback/release/recover
  cleanup semantics.'
acceptance:
  - Add claimed_branch to WU schema and preserve backward compatibility for legacy WUs.
  - Update defaultBranchFrom() to prefer claimed_branch and fall back to lane-derived naming.
  - Allow pre-commit lane-branch commits when claimed_mode is branch-pr.
  - Ensure rollback/release/recover clear both claimed_mode and claimed_branch when resetting to
    ready.
  - Add/extend tests for schema, resolver precedence, and branch-pr hook behavior.
claimed_mode: worktree
worktree_path: worktrees/framework-core-lifecycle-wu-1589
claimed_at: 2026-02-12T09:20:54.716Z
baseline_main_sha: 588bb603074aaabbaaf65829f07ba48425c8b5bf
session_id: d375483a-809f-47a1-80d6-491dafe78232
approved_by:
  - tom@hellm.ai
approved_at: 2026-02-12T09:20:54.721Z
