id: WU-1881
title: Fix multi-instance incremental hydrate duplicate entries in EvidenceStore
lane: 'Framework: Core Lifecycle'
type: bug
status: in_progress
priority: P2
created: 2026-02-19
code_paths:
  - packages/@lumenflow/kernel/src/evidence/evidence-store.ts
tests:
  manual:
    - Verify multi-instance scenario produces no duplicate receipt_ids
  unit:
    - packages/@lumenflow/kernel/src/__tests__/evidence-store.test.ts
  e2e: []
artifacts:
  - .lumenflow/stamps/WU-1881.done
dependencies: []
initiative: INIT-030
risks: []
notes: 'Sizing: Simple (2 files, ~15-20 tool calls, <30% context). Fix localized to incremental
  hydrate path at evidence-store.ts:209-226. Found during INIT-030 Phase 5 code review.'
requires_review: false
assigned_to: tom@hellm.ai
exposure: backend-only
escalation_triggers: []
requires_human_escalation: false
requires_cso_approval: false
requires_cto_approval: false
requires_design_approval: false
description: When two EvidenceStore instances share the same evidenceRoot, Instance A may produce
  duplicate entries in orderedTraces. If A has read data from the active file (cursor > 0) and
  Instance B compacts that data into a segment, A's next readTraces() re-reads the segment (already
  indexed via prior delta read), producing duplicates. Single-process is unaffected.
acceptance:
  - applyTraceToIndexes deduplicates by receipt_id (or equivalent mechanism)
  - 'Multi-instance test: writer compacts after reader has cursor > 0; reader.readTraces() returns
    no duplicates'
  - Single-process behavior unchanged (no performance regression)
claimed_mode: worktree
worktree_path: /home/tom/source/hellmai/os/worktrees/framework-core-lifecycle-wu-1881
claimed_at: 2026-02-19T09:22:51.189Z
baseline_main_sha: be7812e80242d80e26188d9edb67b95dda380c62
session_id: a050e0a4-6ffa-452a-a62b-396ddc6e0a85
approved_by:
  - tom@hellm.ai
approved_at: 2026-02-19T09:22:51.200Z
