id: WU-1684
title: Add vendor-agnostic wu:sandbox command for kernel-enforced worktree isolation
lane: 'Framework: CLI Enforcement'
type: feature
status: ready
priority: P2
created: 2026-02-15
code_paths:
  - packages/@lumenflow/core/src/sandbox-profile.ts
  - packages/@lumenflow/core/src/sandbox-allowlist.ts
  - packages/@lumenflow/core/src/sandbox-backend-linux.ts
  - packages/@lumenflow/core/src/sandbox-backend-macos.ts
  - packages/@lumenflow/core/src/__tests__/sandbox-profile.test.ts
  - packages/@lumenflow/core/src/__tests__/sandbox-allowlist.test.ts
  - packages/@lumenflow/core/src/__tests__/sandbox-backend-linux.test.ts
  - packages/@lumenflow/core/src/__tests__/sandbox-backend-macos.test.ts
  - packages/@lumenflow/cli/src/wu-sandbox.ts
  - packages/@lumenflow/cli/src/__tests__/wu-sandbox.test.ts
  - packages/@lumenflow/core/src/wu-claim-helpers.ts
  - .lumenflow.config.yaml
  - packages/@lumenflow/core/src/sandbox-backend-windows.ts
  - packages/@lumenflow/core/src/__tests__/sandbox-backend-windows.test.ts
tests:
  manual:
    - Run wu:sandbox --id WU-XXXX -- <command> and verify sandboxed process start on the current OS.
    - From inside sandbox, attempt to write to main checkout source file and verify deny
      (EPERM/EACCES).
    - From inside sandbox, read main checkout and .git data and verify reads work normally.
    - From inside sandbox, run git commit in worktree and verify git operations work.
    - From inside sandbox, attempt write via ../ traversal outside worktree and verify deny.
    - From inside sandbox, create symlink in worktree to main checkout and verify writes through
      symlink are denied.
    - Without an available sandbox backend and without explicit override, run wu:sandbox and verify
      fail-closed non-zero exit.
    - With explicit unsandboxed override enabled, verify warning is emitted and command runs
      unsandboxed.
    - On Linux, macOS, and Windows environments, verify backend selection is platform-appropriate
      and enforcement behavior is consistent.
  unit:
    - packages/@lumenflow/core/src/__tests__/sandbox-profile.test.ts
    - packages/@lumenflow/core/src/__tests__/sandbox-allowlist.test.ts
    - packages/@lumenflow/core/src/__tests__/sandbox-backend-linux.test.ts
    - packages/@lumenflow/core/src/__tests__/sandbox-backend-macos.test.ts
    - packages/@lumenflow/core/src/__tests__/sandbox-backend-windows.test.ts
    - packages/@lumenflow/cli/src/__tests__/wu-sandbox.test.ts
  e2e:
    - packages/@lumenflow/cli/e2e/wu-sandbox.test.ts
artifacts:
  - .lumenflow/stamps/WU-1684.done
dependencies: []
spec_refs:
  - LUMENFLOW.md
risks: []
notes: 'Design references: Anthropic sandbox-runtime demonstrates process-level sandboxing patterns;
  apply similar asymmetric model with repository-specific allow-listing. Key constraint: chmod-based
  .git lockdown breaks git operations; enforcement must be process-level, not filesystem permission
  mutation. This layer is additive to existing safety controls (git hooks, client hooks, workflow
  checks), not a replacement. Cross-platform requirement is mandatory: Linux bwrap is one backend,
  not the architecture. 2026-02-15 refinement: fail-closed default + explicit override +
  traversal/symlink escape coverage.'
requires_review: false
assigned_to: tom@hellm.ai
exposure: backend-only
escalation_triggers: []
requires_human_escalation: false
requires_cso_approval: false
requires_cto_approval: false
requires_design_approval: false
description: 'Context: LumenFlow uses git worktrees to isolate agent work, but write-time
  enforcement is currently client-specific. Problem: non-Claude clients can still write to the wrong
  checkout before commit-time hooks run. Solution: add a vendor-agnostic wu:sandbox command with a
  shared SandboxProfile and OS-specific backend adapters. Backends are platform-selected (Linux,
  macOS, Windows) and enforce write restrictions to the claimed worktree while preserving required
  read access (.git, node_modules, source tree). Security default is fail-closed: if no hardened
  backend is available, wu:sandbox exits non-zero unless an explicit unsandboxed override is
  provided.'
acceptance:
  - wu:sandbox --id WU-XXXX -- <command> wraps the command using an OS-native sandbox backend with
    write access restricted to the WU worktree.
  - 'Support matrix is explicit: Linux, macOS, and Windows are supported via platform-specific
    backends behind a shared contract.'
  - Write attempts to main checkout source files from inside sandbox fail with EPERM/EACCES.
  - Read access to main checkout, .git/, and node_modules works normally from inside sandbox.
  - Git operations (add/status/commit) work in the sandboxed worktree.
  - Sandbox allow-list includes worktree dir, /tmp (or platform equivalent), .lumenflow/state/, and
    WU YAML path required for lifecycle writes.
  - .lumenflow.config.yaml includes sandbox configuration for allow/deny paths and override policy.
  - Fail-closed default is enforced when no backend is available; unsandboxed execution requires
    explicit override (LUMENFLOW_SANDBOX_ALLOW_UNSANDBOXED=1) and emits a warning.
  - Path-escape attempts via ../ traversal and symlink traversal outside the claimed worktree are
    denied.
  - Architecture uses abstract SandboxProfile + backend adapters (linux, macos, windows), avoiding
    platform-specific branching in command logic.
  - Automated tests cover backend selection matrix and fail-closed/override behavior across
    supported platforms.
