id: WU-1684
title: Build vendor-agnostic core sandbox engine contract and OS backends
lane: 'Framework: Core Validation'
type: feature
status: in_progress
priority: P2
created: 2026-02-15
code_paths:
  - packages/@lumenflow/core/src/sandbox-profile.ts
  - packages/@lumenflow/core/src/sandbox-allowlist.ts
  - packages/@lumenflow/core/src/sandbox-backend-linux.ts
  - packages/@lumenflow/core/src/sandbox-backend-macos.ts
  - packages/@lumenflow/core/src/sandbox-backend-windows.ts
  - packages/@lumenflow/core/src/index.ts
  - packages/@lumenflow/core/src/__tests__/sandbox-profile.test.ts
  - packages/@lumenflow/core/src/__tests__/sandbox-allowlist.test.ts
  - packages/@lumenflow/core/src/__tests__/sandbox-backend-linux.test.ts
  - packages/@lumenflow/core/src/__tests__/sandbox-backend-macos.test.ts
  - packages/@lumenflow/core/src/__tests__/sandbox-backend-windows.test.ts
tests:
  manual:
    - Build a SandboxProfile from representative worktree/main paths and verify allow-list paths are
      normalized and deterministic.
    - Verify allow-list rejects ../ traversal and symlink escape targets outside the allowed
      workspace envelope.
    - Verify backend resolver selects linux/macos/windows adapters on supported platforms.
    - Verify backend resolver returns fail-closed unsupported result when no hardened backend is
      available and override is not enabled.
    - Verify backend resolver allows explicit unsandboxed fallback only when override policy is
      enabled by caller input.
  unit:
    - packages/@lumenflow/core/src/__tests__/sandbox-profile.test.ts
    - packages/@lumenflow/core/src/__tests__/sandbox-allowlist.test.ts
    - packages/@lumenflow/core/src/__tests__/sandbox-backend-linux.test.ts
    - packages/@lumenflow/core/src/__tests__/sandbox-backend-macos.test.ts
    - packages/@lumenflow/core/src/__tests__/sandbox-backend-windows.test.ts
  e2e: []
artifacts:
  - .lumenflow/stamps/WU-1684.done
dependencies: []
spec_refs:
  - LUMENFLOW.md
risks: []
notes: Split from original WU-1684 proposal into two WUs. This core WU owns only engine-level
  contract and backend adapters. CLI command/public registration and wu:claim wiring are delegated
  to WU-1687 to keep boundaries clean and enable parallel delivery.
requires_review: false
assigned_to: tom@hellm.ai
exposure: backend-only
escalation_triggers: []
requires_human_escalation: false
requires_cso_approval: false
requires_cto_approval: false
requires_design_approval: false
description: 'Context: LumenFlow needs vendor-agnostic write-time isolation semantics that can be
  consumed by multiple clients. Problem: platform sandbox decisions are currently unimplemented and
  would be mixed with CLI concerns if built in one pass. Solution: create a pure core sandbox engine
  boundary that models profile/allowlist generation and backend adapter contracts for Linux, macOS,
  and Windows. The engine exposes deterministic fail-closed behavior and explicit override hooks for
  callers, without direct CLI/process-launch coupling.'
acceptance:
  - Core exposes a shared SandboxProfile contract that is independent of CLI command parsing.
  - Support matrix is explicit and adapter-backed for Linux, macOS, and Windows.
  - Engine returns fail-closed backend resolution when no hardened backend is available by default.
  - Engine supports explicit unsandboxed-allowed mode as caller-provided policy input.
  - Sandbox allow-list generation includes claimed worktree scope, platform temp scope, state write
    scope, and WU metadata write scope required for lifecycle operations.
  - Allow-list normalization denies ../ traversal and symlink-escape write targets outside allowed
    scope.
  - Unit tests cover profile generation, allow-list normalization, backend selection matrix, and
    fail-closed/override decision behavior.
claimed_mode: worktree
worktree_path: /home/tom/source/hellmai/os/worktrees/framework-core-validation-wu-1684
claimed_at: 2026-02-15T14:46:16.128Z
baseline_main_sha: b83f2e5a3ccc9e2004bd00e1a3250af8f504e713
session_id: f39d2c6f-dcbb-405a-b0ad-f5629e7656e1
approved_by:
  - tom@hellm.ai
approved_at: 2026-02-15T14:46:16.134Z
