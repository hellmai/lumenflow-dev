id: WU-1831
title: Implement AG-UI state synchronization with StateSnapshot and StateDelta
lane: 'Framework: MCP'
type: feature
status: ready
priority: P1
created: 2026-02-18
code_paths:
  - packages/@lumenflow/surfaces/http/
tests:
  manual:
    - Connect client, modify task state, verify StateDelta patches arrive
  unit:
    - packages/@lumenflow/surfaces/__tests__/ag-ui-state-sync.test.ts
  e2e: []
artifacts:
  - .lumenflow/stamps/WU-1831.done
dependencies: []
initiative: INIT-031
phase: 3
blocked_by:
  - WU-1818
spec_refs:
  - .claude/plans/zazzy-growing-cook.md
risks: []
notes: (auto) Add implementation notes, rollout context, or a short summary of the plan/conversation.
requires_review: false
assigned_to: tom@hellm.ai
exposure: api
escalation_triggers: []
requires_human_escalation: false
requires_cso_approval: false
requires_cto_approval: false
requires_design_approval: false
description: Implement shared state between frontend and agent. StateSnapshot events from TaskState projection. StateDelta events using RFC 6902 JSON Patch when TaskState changes. MessagesSnapshot from checkpoint and event replay. Uses the EventStore subscribe mechanism.
acceptance:
  - StateSnapshot emitted on initial connection
  - StateDelta emitted as RFC 6902 JSON Patch on state changes
  - MessagesSnapshot built from event replay
