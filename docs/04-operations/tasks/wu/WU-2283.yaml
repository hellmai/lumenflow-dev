id: WU-2283
title: Fix lumenflow:upgrade false failure after successful push
lane: 'Framework: CLI WU Commands'
type: bug
status: ready
priority: P2
created: 2026-03-01
code_paths:
  - packages/@lumenflow/cli/src/lumenflow-upgrade.ts,packages/@lumenflow/core/src/micro-worktree.ts
tests:
  manual:
    - Run pnpm lumenflow:upgrade --latest in a repo where origin/main advances during push; command exits 0 and leaves no divergent local commit
  unit:
    - packages/@lumenflow/cli/src/__tests__/lumenflow-upgrade.test.ts
  e2e: []
artifacts:
  - .lumenflow/stamps/WU-2283.done
dependencies: []
spec_refs:
  - lumenflow://plans/WU-2283-plan.md
risks: []
notes: ''
requires_review: false
assigned_to: tom@hellm.ai
exposure: backend-only
escalation_triggers: []
requires_human_escalation: false
requires_cso_approval: false
requires_cto_approval: false
requires_design_approval: false
description: When origin/main moves during upgrade, lumenflow:upgrade may complete package upgrade + push, then still emit fatal divergence failure from retry path. Make command idempotent and treat already-pushed result as success.
acceptance:
  - Upgrade returns success when target commit already exists on origin/main after retry path
  - No duplicate/local-only upgrade commit left behind after successful remote push
  - Regression test covers retry/remote-ahead path
