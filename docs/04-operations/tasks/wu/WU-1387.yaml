id: WU-1387
title: Fix doctor agent-friction check edge cases
lane: 'Framework: CLI'
type: feature
status: in_progress
priority: P2
created: 2026-02-03
code_paths:
  - packages/@lumenflow/cli/src/doctor.ts
tests:
  manual:
    - Run pnpm lumenflow:doctor --deep and verify output shows lane health and prerequisite status
    - Run pnpm lumenflow:doctor from a subdirectory and verify managed file detection works
  unit:
    - packages/@lumenflow/cli/src/__tests__/doctor.test.ts
  e2e: []
artifacts:
  - .lumenflow/stamps/WU-1387.done
dependencies: []
risks: []
notes: |
  WU-1387 fixes four edge cases identified during WU-1386 review:
  1. parseWorktreePruneOutput helper added for real wu:prune output parsing
  2. checkWUValidity now distinguishes CLI execution failure from validation failure
  3. runDoctorForInit now includes lane health and prerequisite details in output
  4. getGitRepoRoot helper added for correct subdirectory handling
spec_refs:
  - 'lumenflow://plans/WU-1387-doctor-edge-cases.md'
requires_review: false
assigned_to: tom@hellm.ai
exposure: backend-only
escalation_triggers: []
requires_human_escalation: false
requires_cso_approval: false
requires_cto_approval: false
requires_design_approval: false
description: 'Context: WU-1386 review identified edge cases. Problem: (1) Worktree sanity misses
  blocked/unclaimed/orphan-directory warnings, (2) WU validity silently skips on CLI errors, (3)
  runDoctorForInit message inaccurate, (4) Managed-file detection fails from subdirectories.
  Solution: Fix all four issues with proper parsing and path handling.'
acceptance:
  - Worktree sanity detects orphan directories, missing tracked worktrees, stale, blocked, and
    unclaimed worktrees from wu:prune
  - WU validity sets passed=false with clear message when wu:validate fails to run (missing script,
    pnpm error) rather than silently passing
  - runDoctorForInit shows accurate status including lane health and prerequisite failures, not just
    exitCode
  - Managed-file detection uses git repo root for path resolution, works from subdirectories
  - Tests cover real output parsing for worktree sanity and WU validity, not just graceful
    degradation
claimed_mode: worktree
worktree_path: /home/tom/source/hellmai/os/worktrees/framework-cli-wu-1387
claimed_at: 2026-02-03T16:19:05.579Z
baseline_main_sha: f3a3984fe5951bbb3e328e7d989ecf26b1f68f1f
session_id: c7ab8e3c-b3cd-4a3d-a3b9-279581774c0b
approved_by:
  - tom@hellm.ai
approved_at: 2026-02-03T16:19:05.587Z
