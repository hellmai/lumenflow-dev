id: WU-1556
title: Stop lifecycle repair loops and enforce closeout consistency
lane: 'Operations: Tooling'
type: bug
status: done
priority: P0
created: 2026-02-10
code_paths:
  - packages/@lumenflow/core/src/wu-repair-core.ts
  - packages/@lumenflow/core/src/wu-consistency-checker.ts
  - packages/@lumenflow/core/src/wu-done-validation.ts
  - packages/@lumenflow/core/src/wu-done-worktree.ts
  - packages/@lumenflow/core/src/wu-done-metadata.ts
  - packages/@lumenflow/core/src/wu-transaction-collectors.ts
tests:
  manual:
    - Run pnpm wu:repair --all --check on a seeded inconsistent fixture and verify no files/commits
      are created.
    - Run pnpm state:doctor --json after WU closeout fixture flow and verify zero status_mismatch
      for repaired WUs.
  unit:
    - packages/@lumenflow/core/src/__tests__/wu-consistency-checker.test.ts
    - packages/@lumenflow/core/src/__tests__/state-doctor-core.test.ts
    - packages/@lumenflow/cli/src/__tests__/wu-done.test.ts
    - packages/@lumenflow/cli/src/__tests__/state-doctor.test.ts
  e2e: []
artifacts:
  - .lumenflow/stamps/WU-1556.done
dependencies: []
spec_refs:
  - docs/04-operations/tasks/initiatives/INIT-020.yaml
risks: []
notes: 'Observed symptoms to close: state:doctor reports 9 status_mismatch issues; repeated fix:
  repair and fix(state-doctor) commit loops after INIT-020 closeout; status.md In Progress drift;
  mixed completion fields across INIT-020 WUs.'
requires_review: false
claimed_mode: worktree
assigned_to: tom@hellm.ai
claimed_at: 2026-02-10T09:47:33.560Z
worktree_path: /home/USER/source/hellmai/os/worktrees/operations-tooling-wu-1556
session_id: 3b49fe84-00ea-4087-afa1-26df65293bf1
exposure: backend-only
escalation_triggers: []
requires_human_escalation: false
approved_by:
  - tom@hellm.ai
approved_at: 2026-02-10T09:47:33.566Z
requires_cso_approval: false
requires_cto_approval: false
requires_design_approval: false
description: 'Context: INIT-020 closeout produced repeated repair commits while lifecycle state
  stayed inconsistent. Problem: repair/check behavior and metadata reconciliation can leave YAML,
  stamps, status docs, and state store out of sync. Solution: harden repair and done flows, then
  backstop with regression tests written first (TDD).'
acceptance:
  - 'TDD: add failing-first regression test proving wu:repair --all --check is read-only and
    performs no writes/commits.'
  - 'TDD: add failing-first regression test proving batch YAML_DONE_STATUS_IN_PROGRESS repairs are
    cumulative for shared files (no overwrite clobber).'
  - 'TDD: add failing-first regression test proving STAMP_EXISTS_YAML_NOT_DONE repair reconciles
    state so no status_mismatch remains for repaired WUs.'
  - 'TDD: add failing-first regression test proving wu:done success path enforces YAML/stamp/state
    consistency before reporting complete.'
  - 'TDD: add failing-first regression coverage for completion field normalization (completed vs
    completed_at) in done/repair paths.'
locked: true
completed: 2026-02-10
