id: WU-1554
title: Fix wu:done post-merge metadata double-write leaving main dirty
lane: 'Framework: CLI WU Commands'
type: bug
status: in_progress
priority: P1
created: 2026-02-09
code_paths:
  - packages/@lumenflow/cli/src/wu-done.ts
  - packages/@lumenflow/cli/src/__tests__/wu-done.test.ts
  - packages/@lumenflow/core/src/wu-done-worktree.ts
tests:
  manual:
    - Run wu:done on any WU and verify main is clean after
  unit:
    - packages/@lumenflow/cli/src/__tests__/wu-done.test.ts
  e2e: []
artifacts:
  - .lumenflow/stamps/WU-1554.done
dependencies: []
risks: []
notes: 'Three-layer fix: (1) Pre-merge: auto-restore related dirty files in WU-1503 guard
  so ff-only merge can proceed. (2) Pre-merge defensive: git checkout -- . right before
  mergeLaneBranch in executeWorktreeCompletion. (3) Post-merge: checkPostMergeDirtyState
  expanded to three-category classification with metadataFiles auto-committed.'
requires_review: false
assigned_to: tom@hellm.ai
exposure: backend-only
escalation_triggers: []
requires_human_escalation: false
requires_cso_approval: false
requires_cto_approval: false
requires_design_approval: false
description: wu:done writes metadata (WU YAML, backlog, status, wu-events) in worktree, merges to
  main, pushes, then detects uncommitted changes on main. Something re-writes these files on main
  after the merge+push. Blocks all 4 agents.
acceptance:
  - wu:done completes without leaving main dirty
  - Post-merge dirty check passes cleanly
  - Tests cover the post-merge clean state
claimed_mode: worktree
worktree_path: /home/USER/source/hellmai/os/worktrees/framework-cli-wu-commands-wu-1554
claimed_at: 2026-02-09T22:48:33.898Z
baseline_main_sha: 55d674aa8552d3600c126bf18e960d45a9a9c10a
session_id: 284d882f-ecf2-4c8d-a361-f60a56c5fdfc
approved_by:
  - tom@hellm.ai
approved_at: 2026-02-09T22:48:33.903Z
