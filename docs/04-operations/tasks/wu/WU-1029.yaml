id: WU-1029
title: Fix wu:claim fallback to symlink nested node_modules
lane: 'Framework: CLI'
type: feature
status: done
priority: P2
created: 2026-01-19
code_paths:
  - packages/@lumenflow/cli/src/wu-claim.ts
  - packages/@lumenflow/cli/__tests__/wu-claim.test.ts
tests:
  manual:
    - Verify acceptance criteria met
  unit:
    - packages/@lumenflow/cli/__tests__/wu-claim.test.ts
  e2e: []
artifacts:
  - .lumenflow/stamps/WU-1029.done
dependencies: []
spec_refs:
  - internal
risks: []
notes: Completed per acceptance criteria.
requires_review: false
assigned_to: tom@hellm.ai
escalation_triggers: []
requires_human_escalation: false
requires_cso_approval: false
requires_cto_approval: false
requires_design_approval: false
description: >-
  Context: wu:claim installs worktree deps with pnpm; if install fails it falls back to symlinking
  only the root node_modules.

  Problem: the fallback omits nested package node_modules (e.g. packages/@lumenflow/cli), so
  worktree commands fail with ERR_MODULE_NOT_FOUND.

  Solution: when pnpm install fails, also run symlinkNestedNodeModules and log the result so
  workspace deps resolve.
acceptance:
  - If pnpm install fails during wu:claim, fallback symlinks both root and nested package
    node_modules so workspace package deps resolve in the worktree.
  - Add coverage for the fallback path (wu-claim) to ensure nested node_modules symlinks are created.
  - pnpm format, lint, typecheck -> PASS
claimed_mode: worktree
worktree_path: worktrees/framework-cli-wu-1029
claimed_at: 2026-01-20T13:18:31.202Z
baseline_main_sha: 44ec28559b5bbc7e054dd7c137c76eea47976e0b
session_id: 38dbc6c3-6b3e-443c-b73f-fb9e627e3a4e
approved_by:
  - tom@hellm.ai
approved_at: 2026-01-20T13:18:31.209Z
locked: true
completed_at: 2026-01-20T13:32:34.418Z
