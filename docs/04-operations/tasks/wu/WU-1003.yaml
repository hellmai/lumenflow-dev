id: WU-1003
title: Add rate limiting to Gates Action
lane: Infrastructure
type: feature
status: ready
priority: P2
created: 2026-01-18
code_paths:
  - 'actions/lumenflow-gates/action.yml'
  - 'apps/github-app/api/validate-token.ts'
  - 'apps/github-app/src/lib/billing.ts'
tests:
  manual:
    - 'Gates Action rejects requests without token'
    - 'Gates Action enforces 10 WU/month limit for free tier'
  unit:
    - 'apps/github-app/src/lib/__tests__/billing.test.ts'
  e2e: []
artifacts:
  - .beacon/stamps/WU-1003.done
dependencies:
  - WU-1002
risks:
  - 'Supabase schema changes may require migration'
notes: ''
requires_review: false
assigned_to: tom@hellm.ai
escalation_triggers: []
requires_human_escalation: false
requires_cso_approval: false
requires_cto_approval: false
requires_design_approval: false
description: |
  Add rate limiting to Gates Action before Marketplace launch.

  Context: Gates Action is ready but has no usage limits.
  Problem: Without limits, free tier would be unlimited (bad for monetization).
  Solution: Add token validation endpoint + usage tracking in Supabase.

  Components:
  1. Token input in action.yml (required)
  2. /api/validate-token endpoint in GitHub App
  3. Usage tracking in Supabase (lumenflow_usage table)
  4. Limit enforcement (10 WUs/month free, 100 team, 500 business)
acceptance:
  - 'Gates Action has required token input'
  - 'Validation endpoint checks tier and usage'
  - 'Free tier limited to 10 gates runs/month'
  - 'Usage tracked in Supabase'
  - pnpm format, lint, typecheck â†’ PASS
