id: WU-1003
title: Add rate limiting to Gates Action
lane: Infrastructure
type: feature
status: done
priority: P2
created: 2026-01-18
code_paths:
  - actions/lumenflow-gates/action.yml
  - apps/github-app/api/validate-token.ts
  - apps/github-app/src/lib/billing.ts
tests:
  manual:
    - Gates Action rejects requests without token
    - Gates Action enforces 10 WU/month limit for free tier
  unit:
    - apps/github-app/src/lib/__tests__/billing.test.ts
  e2e: []
artifacts:
  - .lumenflow/stamps/WU-1003.done
dependencies:
  - WU-1002
spec_refs:
  - internal
risks:
  - Supabase schema changes may require migration
exposure: api
notes: |
  MVP uses in-memory storage for rate limiting. TODOs mark where Supabase
  integration is needed for production persistence. In-memory is acceptable
  for MVP/launch since: (1) usage resets on deploy which is fine for soft
  launch, (2) allows shipping rate limiting without Supabase schema setup.
requires_review: false
assigned_to: tom@hellm.ai
escalation_triggers: []
requires_human_escalation: false
requires_cso_approval: false
requires_cto_approval: false
requires_design_approval: false
description: |
  Add rate limiting to Gates Action before Marketplace launch.

  Context: Gates Action is ready but has no usage limits.
  Problem: Without limits, free tier would be unlimited (bad for monetization).
  Solution: Add token validation endpoint + usage tracking in Supabase.

  Components:
  1. Token input in action.yml (required)
  2. /api/validate-token endpoint in GitHub App
  3. Usage tracking in Supabase (lumenflow_usage table)
  4. Limit enforcement (10 WUs/month free, 100 team, 500 business)
acceptance:
  - Gates Action has required token input
  - Validation endpoint checks tier and usage
  - Free tier limited to 10 gates runs/month
  - Usage tracked in Supabase
  - pnpm format, lint, typecheck â†’ PASS
claimed_mode: worktree
worktree_path: worktrees/infrastructure-wu-1003
claimed_at: 2026-01-18T18:00:48.419Z
baseline_main_sha: 07a62e9e890b65bdd9e949c103cb698eb12e4de2
session_id: 263b1b7a-6cc9-4848-adf2-61ac26912541
approved_by:
  - tom@hellm.ai
approved_at: 2026-01-18T18:00:48.426Z
locked: true
completed_at: 2026-01-18T18:14:08.137Z
