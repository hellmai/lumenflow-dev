version: '2.0'
project: lumenflow

# WU-1022: Lane enforcement configuration
# Controls how lane format validation behaves
lanes:
  enforcement:
    # When true, lanes MUST use "Parent: Sublane" format if parent has taxonomy
    require_parent: true
    # When false, only lanes in the taxonomy are allowed. When true, custom lanes can be used.
    allow_custom: false

  # Lane definitions with full "Parent: Sublane" format
  # These map to the taxonomy in .lumenflow.lane-inference.yaml
  definitions:
    # ------------------------------------------------------------------------
    # Framework lanes (granular)
    # ------------------------------------------------------------------------
    - name: 'Framework: Core Lifecycle'
      wip_limit: 2
      wip_justification: 'Lifecycle work can parallelize when code_paths are disjoint and non-overlapping'
      lock_policy: 'none'
      code_paths:
        - 'packages/@lumenflow/core/src/wu-claim-*.ts'
        - 'packages/@lumenflow/core/src/wu-done-*.ts'
        - 'packages/@lumenflow/core/src/wu-create-*.ts'
        - 'packages/@lumenflow/core/src/wu-preflight-*.ts'
        - 'packages/@lumenflow/core/src/wu-helpers.ts'
        - 'packages/@lumenflow/core/src/wu-list.ts'
        - 'packages/@lumenflow/core/src/wu-paths.ts'
        - 'packages/@lumenflow/core/src/lane-*.ts'
        - 'packages/@lumenflow/core/src/worktree-*.ts'
        - 'packages/@lumenflow/core/src/backlog-*.ts'
        - 'packages/@lumenflow/core/src/dependency-*.ts'
        - 'packages/@lumenflow/core/src/git-*.ts'

    - name: 'Framework: Core Validation'
      wip_limit: 2
      wip_justification: 'Validation/schema work can parallelize across separate validator families'
      lock_policy: 'none'
      code_paths:
        - 'packages/@lumenflow/core/src/validation/**'
        - 'packages/@lumenflow/core/src/validators/**'
        - 'packages/@lumenflow/core/src/schemas/**'
        - 'packages/@lumenflow/core/src/invariants/**'
        - 'packages/@lumenflow/core/src/wu-validator.ts'
        - 'packages/@lumenflow/core/src/wu-validation*.ts'
        - 'packages/@lumenflow/core/src/manual-test-validator.ts'
        - 'packages/@lumenflow/core/src/prompt-linter.ts'
        - 'packages/@lumenflow/core/src/code-path-validator.ts'
        - 'packages/@lumenflow/core/src/system-map-validator.ts'
        - 'packages/@lumenflow/core/src/coverage-gate.ts'

    - name: 'Framework: Core State Recovery'
      wip_limit: 1
      code_paths:
        - 'packages/@lumenflow/core/src/state-*.ts'
        - 'packages/@lumenflow/core/src/wu-state-*.ts'
        - 'packages/@lumenflow/core/src/*recover*.ts'
        - 'packages/@lumenflow/core/src/rollback-*.ts'
        - 'packages/@lumenflow/core/src/cleanup-*.ts'
        - 'packages/@lumenflow/core/src/merge-lock.ts'
        - 'packages/@lumenflow/core/src/cleanup-lock.ts'
        - 'packages/@lumenflow/core/src/wu-transaction*.ts'
        - 'packages/@lumenflow/core/src/stamp-*.ts'
        - 'packages/@lumenflow/core/src/orphan-detector.ts'

    - name: 'Framework: CLI WU Commands'
      wip_limit: 2
      wip_justification: 'WU CLI command families can parallelize on specific command files'
      lock_policy: 'none'
      code_paths:
        - 'packages/@lumenflow/cli/src/wu-*.ts'
        - 'packages/@lumenflow/cli/src/__tests__/wu-*.test.ts'

    - name: 'Framework: CLI Memory State'
      wip_limit: 2
      wip_justification: 'Memory/state command families can parallelize with narrow code_paths'
      lock_policy: 'none'
      code_paths:
        - 'packages/@lumenflow/cli/src/mem-*.ts'
        - 'packages/@lumenflow/cli/src/state-*.ts'
        - 'packages/@lumenflow/cli/src/signal-*.ts'
        - 'packages/@lumenflow/cli/src/backlog-prune.ts'
        - 'packages/@lumenflow/cli/src/__tests__/mem-*.test.ts'
        - 'packages/@lumenflow/cli/src/__tests__/state-*.test.ts'

    - name: 'Framework: CLI Orchestration'
      wip_limit: 2
      wip_justification: 'Initiative/spawn/orchestration commands can run in parallel with disjoint files'
      lock_policy: 'none'
      code_paths:
        - 'packages/@lumenflow/cli/src/initiative-*.ts'
        - 'packages/@lumenflow/cli/src/orchestrate-*.ts'
        - 'packages/@lumenflow/cli/src/spawn-*.ts'
        - 'packages/@lumenflow/cli/src/agent-*.ts'
        - 'packages/@lumenflow/cli/src/flow-*.ts'
        - 'packages/@lumenflow/cli/src/metrics-*.ts'
        - 'packages/@lumenflow/cli/src/__tests__/initiative-*.test.ts'
        - 'packages/@lumenflow/cli/src/__tests__/orchestrate-*.test.ts'
        - 'packages/@lumenflow/cli/src/__tests__/spawn-*.test.ts'

    - name: 'Framework: CLI Enforcement'
      wip_limit: 1
      code_paths:
        - 'packages/@lumenflow/cli/src/hooks/**'
        - 'packages/@lumenflow/cli/src/gates.ts'
        - 'packages/@lumenflow/cli/src/validate.ts'
        - 'packages/@lumenflow/cli/src/lane-*.ts'
        - 'packages/@lumenflow/cli/src/init.ts'
        - 'packages/@lumenflow/cli/src/doctor.ts'
        - 'packages/@lumenflow/cli/src/release.ts'
        - 'packages/@lumenflow/cli/src/docs-sync.ts'
        - 'packages/@lumenflow/cli/src/sync-templates.ts'
        - 'packages/@lumenflow/cli/src/public-manifest.ts'
        - 'packages/@lumenflow/cli/src/commands/integrate.ts'
        - 'packages/@lumenflow/cli/src/__tests__/hooks/**'

    # Existing package-focused framework lanes
    - name: 'Framework: MCP'
      wip_limit: 1
      code_paths:
        - 'packages/@lumenflow/mcp/**'

    - name: 'Framework: Memory'
      wip_limit: 1
      code_paths:
        - 'packages/@lumenflow/memory/**'

    - name: 'Framework: Agent'
      wip_limit: 1
      code_paths:
        - 'packages/@lumenflow/agent/**'

    - name: 'Framework: Metrics'
      wip_limit: 1
      code_paths:
        - 'packages/@lumenflow/metrics/**'

    - name: 'Framework: Initiatives'
      wip_limit: 1
      code_paths:
        - 'packages/@lumenflow/initiatives/**'

    - name: 'Framework: Shims'
      wip_limit: 1
      code_paths:
        - 'packages/@lumenflow/shims/**'

    # ------------------------------------------------------------------------
    # Operations lanes
    # ------------------------------------------------------------------------
    - name: 'Operations: Runtime'
      wip_limit: 1
      code_paths:
        - 'apps/github-app/**'

    - name: 'Operations: Tooling'
      wip_limit: 1
      code_paths:
        - 'tools/**'
        - 'scripts/**'
        - '.husky/**'
        - 'packages/linters/**'
        - 'benchmark.js'
        - 'eslint.config.mjs'
        - 'prettier.config.mjs'
        - 'vitest.config.ts'
        - 'vitest.config.ts.timestamp-*.mjs'
        - 'tsconfig.json'
        - 'tsconfig.build.json'
        - 'turbo.json'
        - 'pnpm-workspace.yaml'

    - name: 'Operations: Automation'
      wip_limit: 1
      code_paths:
        - '.github/**'
        - 'actions/**'

    # ------------------------------------------------------------------------
    # Content lanes
    # ------------------------------------------------------------------------
    - name: 'Content: Specs Governance'
      wip_limit: 2
      wip_justification: 'Spec/governance work can parallelize when targeting different docs and config files'
      lock_policy: 'none'
      code_paths:
        - 'docs/04-operations/**'
        - '.lumenflow.config.yaml'
        - '.lumenflow.lane-inference.yaml'
        - '.lumenflow/**'

    - name: 'Content: Framework Docs'
      wip_limit: 2
      wip_justification: 'Framework docs are generally low-conflict and can run in parallel'
      lock_policy: 'none'
      code_paths:
        - 'docs/_frameworks/**'
        - 'LUMENFLOW.md'
        - 'START-HERE.md'
        - 'CLAUDE.md'
        - 'AGENTS.md'

    - name: 'Content: Site Comms'
      wip_limit: 2
      wip_justification: 'Docs site and comms content can usually parallelize by section'
      lock_policy: 'none'
      code_paths:
        - 'apps/docs/**'
        - 'docs/posts/**'
        - 'README.md'
        - 'CHANGELOG.md'

    # ------------------------------------------------------------------------
    # Legacy compatibility lanes (retain while existing WUs still reference these)
    # ------------------------------------------------------------------------
    - name: 'Framework: Core'
      wip_limit: 1
      code_paths:
        - 'packages/@lumenflow/core/**'

    - name: 'Framework: CLI'
      wip_limit: 1
      code_paths:
        - 'packages/@lumenflow/cli/**'

    - name: 'Operations: Infrastructure'
      wip_limit: 1
      code_paths:
        - 'apps/github-app/**'
        - 'actions/**'

    - name: 'Operations: CI/CD'
      wip_limit: 1
      code_paths:
        - '.github/**'

    - name: 'Content: Documentation'
      wip_limit: 1
      code_paths:
        - 'docs/**'
        - 'apps/docs/**'

git:
  main_branch: main
  branch_pattern: 'lane/{lane}/{wu_id}'
  # Agent branch patterns - branches matching these can bypass worktree requirements
  # Use for cloud agents (Claude/Codex web) that manage their own isolation
  agent_branch_patterns:
    - 'agent/*'
    - 'claude/*'
    - 'codex/*'

directories:
  wu_specs: 'docs/04-operations/tasks/wu'
  backlog: 'docs/04-operations/tasks/backlog.md'
  status: 'docs/04-operations/tasks/status.md'
  stamps: '.lumenflow/stamps'
  skillsDir: '.claude/skills'
  agentsDir: '.claude/agents'

worktree_pattern: 'worktrees/{lane}-{wu_id}'

# WU-1053: Agent and skill configuration for AI clients
agents:
  defaultClient: 'claude-code'
  clients:
    claude-code:
      preamble: true
      skillsDir: '.claude/skills'
      agentsDir: '.claude/agents'
      skills:
        instructions: 'Load skills based on WU context:'
        recommended:
          - wu-lifecycle
          - worktree-discipline
        byLane:
          'Framework: Core Lifecycle':
            - tdd-workflow
            - lumenflow-gates
          'Framework: Core Validation':
            - tdd-workflow
            - lumenflow-gates
          'Framework: Core State Recovery':
            - tdd-workflow
            - lumenflow-gates
          'Framework: CLI WU Commands':
            - tdd-workflow
            - lumenflow-gates
          'Framework: CLI Memory State':
            - tdd-workflow
            - lumenflow-gates
          'Framework: CLI Orchestration':
            - tdd-workflow
            - lumenflow-gates
          'Framework: CLI Enforcement':
            - tdd-workflow
            - lumenflow-gates
          'Framework: MCP':
            - tdd-workflow
            - lumenflow-gates
          'Framework: Core':
            - tdd-workflow
            - lumenflow-gates
          'Framework: CLI':
            - tdd-workflow
            - lumenflow-gates
          'Content: Specs Governance':
            - worktree-discipline
          'Content: Framework Docs':
            - worktree-discipline
          'Content: Site Comms':
            - worktree-discipline
          'Content: Documentation':
            - worktree-discipline
          'Operations: Runtime':
            - orchestration
          'Operations: Tooling':
            - orchestration
          'Operations: Automation':
            - orchestration
          'Operations: Infrastructure':
            - orchestration
      blocks:
        - title: 'Claude Code Best Practices'
          content: |
            - Use TodoWrite for multi-step tasks
            - Run gates before wu:done
            - Never use --no-verify
            - Load skills via /skill <name>
    codex-cli:
      preamble: true
      skillsDir: '.claude/skills'
    gemini-cli:
      preamble: true
      skillsDir: '.claude/skills'

# WU-1495: Cloud auto-detection configuration
# Controls opt-in cloud mode detection via environment signals.
# Explicit activation (--cloud / LUMENFLOW_CLOUD=1) always takes precedence.
# cloud:
#   auto_detect: false     # Set true to enable env-signal auto-detection
#   env_signals:           # Environment signals to check (user-configured, no hardcoded vendors)
#     - name: CI           # Presence check: any non-empty value triggers detection
#     - name: CODEX
#     - name: GITHUB_ACTIONS
#       equals: 'true'     # Exact match: value must equal 'true'

# WU-1203: Memory layer configuration
# Controls memory persistence, checkpoints, and sub-agent coordination signals
memory:
  # Memory directory (default: 'memory-bank/')
  directory: 'memory-bank/'
  # Progress signals for sub-agent coordination
  # When enabled, spawn prompts include mandatory signal directives
  # progress_signals:
  #   enabled: false        # Set true to make signals mandatory in spawn prompts
  #   frequency: 0          # Signal every N tool calls (0 = disabled)
  #   on_milestone: true    # Signal after each acceptance criterion completed
  #   on_tests_pass: true   # Signal when tests first pass
  #   before_gates: true    # Signal before running gates
  #   on_blocked: true      # Signal when work is blocked
  #   auto_checkpoint: false # Automatically checkpoint memory at signal milestones
