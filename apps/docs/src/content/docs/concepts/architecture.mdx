---
title: Hexagonal Architecture
description: Understanding the ports and adapters pattern in @lumenflow/core
---

import { Aside, Card, CardGrid, LinkCard } from '@astrojs/starlight/components';

LumenFlow's core package follows **hexagonal architecture** (also known as ports and adapters) to enable clean separation of concerns, dependency injection, and testability.

## Why Hexagonal Architecture?

<CardGrid>
  <Card title="Testability" icon="approve-check">
    Inject mock adapters for deterministic tests without real I/O
  </Card>
  <Card title="Extensibility" icon="puzzle">
    Replace adapters for different environments (CI/CD, testing, custom git providers)
  </Card>
  <Card title="Maintainability" icon="setting">
    Changes to git implementation don't affect validation logic
  </Card>
  <Card title="Backwards Compatible" icon="rocket">
    Original API preserved - no migration required
  </Card>
</CardGrid>

## Architecture Overview

```
+---------------------------+
|        Use Cases          |  Application layer (orchestration)
|  ComputeContextUseCase    |
|  ValidateCommandUseCase   |
|  AnalyzeRecoveryUseCase   |
+------------+--------------+
             |
             | depends on
             v
+---------------------------+
|      Port Interfaces      |  Abstractions (contracts)
|    ILocationResolver      |
|    IGitStateReader        |
|    IWuStateReader         |
|    ICommandRegistry       |
|    IRecoveryAnalyzer      |
+------------+--------------+
             ^
             | implements
             |
+---------------------------+
|     Adapter Classes       |  Infrastructure layer
|  SimpleGitLocationAdapter |
|  SimpleGitStateAdapter    |
|  FileSystemWuStateAdapter |
|  CommandRegistryAdapter   |
|  RecoveryAnalyzerAdapter  |
+---------------------------+
```

## Key Principles

### 1. Ports Define Contracts

Port interfaces in `src/ports/` define what capabilities the application needs, not how they are implemented.

```typescript
// Port interface - defines WHAT is needed
interface ILocationResolver {
  resolveLocation(cwd?: string): Promise<LocationContext>;
}
```

### 2. Adapters Implement Ports

Concrete adapters in `src/adapters/` implement port interfaces using specific technologies.

```typescript
// Adapter - implements HOW
class SimpleGitLocationAdapter implements ILocationResolver {
  async resolveLocation(cwd?: string): Promise<LocationContext> {
    // Uses simple-git under the hood
    return await resolveLocation(cwd);
  }
}
```

### 3. Use Cases Orchestrate

Use case classes receive dependencies via constructor injection.

```typescript
class ComputeContextUseCase {
  constructor(
    private readonly locationResolver: ILocationResolver,
    private readonly gitStateReader: IGitStateReader,
    private readonly wuStateReader: IWuStateReader,
  ) {}

  async execute(options: ComputeContextOptions): Promise<WuContext> {
    // Orchestrate adapters to compute context
  }
}
```

### 4. Factory Functions Wire It Together

The composition root (`context-di.ts`) provides factory functions for convenient use.

```typescript
import { createComputeContextUseCase } from '@lumenflow/core';

// Creates use case with default adapters
const useCase = createComputeContextUseCase();
const context = await useCase.execute({ wuId: 'WU-1095' });
```

## The Golden Rule

<Aside type="caution" title="Dependency Direction">
  Application layer (use cases) **NEVER** imports infrastructure layer (adapters) directly.
  Dependencies flow inward: adapters implement ports, use cases depend on ports.
</Aside>

## Usage Patterns

### Level 1: Convenience Functions (Simplest)

For basic usage, the original API works unchanged:

```typescript
import { computeWuContext, validateCommand, analyzeRecoveryIssues } from '@lumenflow/core';

const context = await computeWuContext({ wuId: 'WU-1095' });
const validation = await validateCommand('wu:done', context);
const recovery = await analyzeRecoveryIssues(context);
```

### Level 2: Factory Functions with Defaults

For more control, use factory functions:

```typescript
import { createComputeContextUseCase, createValidateCommandUseCase } from '@lumenflow/core';

const computeContext = createComputeContextUseCase();
const validateCommand = createValidateCommandUseCase();

const context = await computeContext.execute({ wuId: 'WU-1095' });
const result = await validateCommand.execute('wu:done', context);
```

### Level 3: Custom Adapters (Testing)

Inject mock adapters for deterministic testing:

```typescript
import { createComputeContextUseCase } from '@lumenflow/core';
import type { ILocationResolver } from '@lumenflow/core';

const mockLocation: ILocationResolver = {
  resolveLocation: async () => ({
    type: 'worktree',
    cwd: '/test/worktrees/ops-wu-1095',
    gitRoot: '/test/worktrees/ops-wu-1095',
    mainCheckout: '/test',
    worktreeName: 'ops-wu-1095',
    worktreeWuId: 'WU-1095',
  }),
};

const useCase = createComputeContextUseCase({
  locationResolver: mockLocation,
  // Other adapters use defaults
});

const context = await useCase.execute({ wuId: 'WU-1095' });
// Assertions are deterministic - no real I/O
expect(context.location.type).toBe('worktree');
```

### Level 4: Manual Wiring (Full Control)

For complete control, wire adapters manually:

```typescript
import {
  ComputeContextUseCase,
  SimpleGitLocationAdapter,
  SimpleGitStateAdapter,
  FileSystemWuStateAdapter,
} from '@lumenflow/core';

const useCase = new ComputeContextUseCase(
  new SimpleGitLocationAdapter(),
  new SimpleGitStateAdapter(),
  new FileSystemWuStateAdapter(),
);
```

## Port Interfaces Reference

| Port Interface      | Purpose                                     |
| ------------------- | ------------------------------------------- |
| `ILocationResolver` | Detect main checkout vs worktree            |
| `IGitStateReader`   | Read git branch, dirty state, ahead/behind  |
| `IWuStateReader`    | Read WU state from YAML and state store     |
| `ICommandRegistry`  | Provide command definitions and validation  |
| `IRecoveryAnalyzer` | Detect state inconsistencies, suggest fixes |

## Adapter Classes Reference

| Adapter                    | Implements          | Description                    |
| -------------------------- | ------------------- | ------------------------------ |
| `SimpleGitLocationAdapter` | `ILocationResolver` | Uses simple-git for resolution |
| `SimpleGitStateAdapter`    | `IGitStateReader`   | Uses simple-git for state      |
| `FileSystemWuStateAdapter` | `IWuStateReader`    | Reads YAML files from disk     |
| `CommandRegistryAdapter`   | `ICommandRegistry`  | Wraps static command registry  |
| `RecoveryAnalyzerAdapter`  | `IRecoveryAnalyzer` | Wraps recovery analysis logic  |

## Use Case Classes Reference

| Use Case                 | Dependencies                                             | Purpose                          |
| ------------------------ | -------------------------------------------------------- | -------------------------------- |
| `ComputeContextUseCase`  | `ILocationResolver`, `IGitStateReader`, `IWuStateReader` | Compute full WU context          |
| `ValidateCommandUseCase` | `ICommandRegistry`                                       | Validate command against context |
| `AnalyzeRecoveryUseCase` | `IRecoveryAnalyzer`                                      | Detect and suggest recovery      |

## Further Reading

<CardGrid>
  <LinkCard
    title="Port Interfaces"
    description="Complete reference for all port interfaces"
    href="/reference/ports/"
  />
  <LinkCard
    title="ADR-001"
    description="Architecture Decision Record for hexagonal architecture"
    href="https://github.com/hellmai/os/blob/main/docs/04-operations/adr/ADR-001-hexagonal-architecture.md"
  />
  <LinkCard
    title="Migration Guide"
    description="Guide for external consumers"
    href="https://github.com/hellmai/os/blob/main/docs/04-operations/adr/migration-guide-hexagonal-architecture.md"
  />
  <LinkCard
    title="@lumenflow/core"
    description="Package README with examples"
    href="https://github.com/hellmai/os/tree/main/packages/@lumenflow/core"
  />
</CardGrid>
