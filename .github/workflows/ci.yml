name: CI

on:
  push:
    branches:
      - main
    paths-ignore:
      # LumenFlow operational files (WU specs, stamps, state, sessions)
      - 'docs/04-operations/tasks/wu/**'
      - 'docs/04-operations/tasks/backlog.md'
      - 'docs/04-operations/tasks/status.md'
      - '.lumenflow/stamps/**'
      - '.lumenflow/state/**'
      - '.lumenflow/sessions/**'
      - '.lumenflow/plans/**'
      - '.lumenflow/telemetry/**'
      - '.lumenflow/flow.log'
      - '.lumenflow/skip-gates-audit.log'
      # Documentation and markdown files
      - '*.md'
      - 'docs/**/*.md'
  pull_request:
    branches:
      - main
    paths-ignore:
      - 'docs/04-operations/tasks/wu/**'
      - 'docs/04-operations/tasks/backlog.md'
      - 'docs/04-operations/tasks/status.md'
      - '.lumenflow/stamps/**'
      - '.lumenflow/state/**'
      - '.lumenflow/sessions/**'
      - '.lumenflow/plans/**'
      - '.lumenflow/telemetry/**'
      - '.lumenflow/flow.log'
      - '.lumenflow/skip-gates-audit.log'
      - '*.md'
      - 'docs/**/*.md'

jobs:
  gates:
    name: Gates
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        # Uses packageManager field from package.json

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Audit dependencies
        run: pnpm audit --audit-level=moderate

      - name: Format check
        run: pnpm format:check

      - name: Lint
        run: pnpm lint

      - name: Typecheck
        run: pnpm typecheck

      - name: Test
        run: pnpm test

      - name: Build
        run: pnpm build

      - name: Validate docs sync
        run: pnpm docs:validate

      - name: Check template drift
        run: pnpm sync:templates --check-drift
